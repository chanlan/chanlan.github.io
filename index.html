<!doctype html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="代码也是有灵魂的">
<meta property="og:type" content="website">
<meta property="og:title" content="Learn And Life.">
<meta property="og:url" content="http://chanlan.github.io/index.html">
<meta property="og:site_name" content="Learn And Life.">
<meta property="og:description" content="代码也是有灵魂的">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Learn And Life.">
<meta name="twitter:description" content="代码也是有灵魂的">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://chanlan.github.io/"/>





  <title> Learn And Life. </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Learn And Life.</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Focus on php and open source.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/07/12/php-mem/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/12/php-mem/" itemprop="url">
                  PHP Graph
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-12T13:20:51+08:00">
                2017-07-12
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="PHP内存模型"><a href="#PHP内存模型" class="headerlink" title="PHP内存模型"></a>PHP内存模型</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">jemalloc</div><div class="line">tcmalloc</div></pre></td></tr></table></figure>
<h1 id="PHP-Memory-Management"><a href="#PHP-Memory-Management" class="headerlink" title="PHP Memory Management"></a>PHP Memory Management</h1><p><img src="/2017/07/12/php-mem/php-datastruct/php-memory.png" alt="memory management for php"></p>
<p>php内存管理分为3层</p>
<p><img src="/2017/07/12/php-mem/php-datastruct/php-arch.jpg" alt="memory arch for php"><br>当然你也可以通过setenv(“USE_ZEND_ALLOC”) = 0直接使用系统调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">static void alloc_globals_ctor(zend_alloc_globals *alloc_globals)</div><div class="line">&#123;</div><div class="line">#if ZEND_MM_CUSTOM</div><div class="line">	char *tmp = getenv(&quot;USE_ZEND_ALLOC&quot;);</div><div class="line"></div><div class="line">	if (tmp &amp;&amp; !zend_atoi(tmp, 0)) &#123;</div><div class="line">		alloc_globals-&gt;mm_heap = malloc(sizeof(zend_mm_heap));</div><div class="line">		memset(alloc_globals-&gt;mm_heap, 0, sizeof(zend_mm_heap));</div><div class="line">		alloc_globals-&gt;mm_heap-&gt;use_custom_heap = ZEND_MM_CUSTOM_HEAP_STD;</div><div class="line">		alloc_globals-&gt;mm_heap-&gt;custom_heap.std._malloc = __zend_malloc;</div><div class="line">		alloc_globals-&gt;mm_heap-&gt;custom_heap.std._free = free;</div><div class="line">		alloc_globals-&gt;mm_heap-&gt;custom_heap.std._realloc = __zend_realloc;</div><div class="line">		return;</div><div class="line">	&#125;</div><div class="line">#endif</div><div class="line">#ifdef MAP_HUGETLB</div><div class="line">	tmp = getenv(&quot;USE_ZEND_ALLOC_HUGE_PAGES&quot;);</div><div class="line">	if (tmp &amp;&amp; zend_atoi(tmp, 0)) &#123;</div><div class="line">		zend_mm_use_huge_pages = 1;</div><div class="line">	&#125;</div><div class="line">#endif</div><div class="line">	ZEND_TSRMLS_CACHE_UPDATE();</div><div class="line">	alloc_globals-&gt;mm_heap = zend_mm_init();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从alloc_globals_ctor可以看到，当关闭USE_ZEND_ALLOC之后，php会通过malloc来管理head的内存分配，而不是mmap的方式。同时，使用malloc分配内存的方式也称为持久的内存分配方式，php代码中也涉及相关的内容</p>
<h1 id="持久内存分配"><a href="#持久内存分配" class="headerlink" title="持久内存分配"></a>持久内存分配</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">#define pemalloc(size, persistent) ((persistent)?__zend_malloc(size):emalloc(size))</div><div class="line">#define safe_pemalloc(nmemb, size, offset, persistent)	((persistent)?_safe_malloc(nmemb, size, offset):safe_emalloc(nmemb, size, offset))</div><div class="line">#define pefree(ptr, persistent)  ((persistent)?free(ptr):efree(ptr))</div><div class="line">#define pefree_size(ptr, size, persistent)  ((persistent)?free(ptr):efree_size(ptr, size))</div><div class="line">#define pecalloc(nmemb, size, persistent) ((persistent)?__zend_calloc((nmemb), (size)):ecalloc((nmemb), (size)))</div><div class="line">#define perealloc(ptr, size, persistent) ((persistent)?__zend_realloc((ptr), (size)):erealloc((ptr), (size)))</div><div class="line">#define perealloc2(ptr, size, copy_size, persistent) ((persistent)?__zend_realloc((ptr), (size)):erealloc2((ptr), (size), (copy_size)))</div><div class="line">#define safe_perealloc(ptr, nmemb, size, offset, persistent)	((persistent)?_safe_realloc((ptr), (nmemb), (size), (offset)):safe_erealloc((ptr), (nmemb), (size), (offset)))</div><div class="line">#define perealloc_recoverable(ptr, size, persistent) ((persistent)?realloc((ptr), (size)):erealloc_recoverable((ptr), (size)))</div><div class="line">#define perealloc2_recoverable(ptr, size, persistent) ((persistent)?realloc((ptr), (size)):erealloc2_recoverable((ptr), (size), (copy_size)))</div><div class="line">#define pestrdup(s, persistent) ((persistent)?strdup(s):estrdup(s))</div><div class="line">#define pestrndup(s, length, persistent) ((persistent)?zend_strndup((s),(length)):estrndup((s),(length)))</div><div class="line"></div><div class="line">#define pemalloc_rel(size, persistent) ((persistent)?__zend_malloc(size):emalloc_rel(size))</div><div class="line">#define pefree_rel(ptr, persistent)	((persistent)?free(ptr):efree_rel(ptr))</div><div class="line">#define pecalloc_rel(nmemb, size, persistent) ((persistent)?__zend_calloc((nmemb), (size)):ecalloc_rel((nmemb), (size)))</div><div class="line">#define perealloc_rel(ptr, size, persistent) ((persistent)?__zend_realloc((ptr), (size)):erealloc_rel((ptr), (size)))</div><div class="line">#define perealloc2_rel(ptr, size, copy_size, persistent) ((persistent)?__zend_realloc((ptr), (size)):erealloc2_rel((ptr), (size), (copy_size)))</div><div class="line">#define perealloc_recoverable_rel(ptr, size, persistent) ((persistent)?realloc((ptr), (size)):erealloc_recoverable_rel((ptr), (size)))</div><div class="line">#define perealloc2_recoverable_rel(ptr, size, copy_size, persistent) ((persistent)?realloc((ptr), (size)):erealloc2_recoverable_rel((ptr), (size), (copy_size)))</div><div class="line">#define pestrdup_rel(s, persistent) ((persistent)?strdup(s):estrdup_rel(s))</div></pre></td></tr></table></figure>
<p>我们可以拿几个来看看</p>
<h2 id="持久化内存"><a href="#持久化内存" class="headerlink" title="持久化内存"></a>持久化内存</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">ZEND_API void * __zend_malloc(size_t len)</div><div class="line">&#123;</div><div class="line">	void *tmp = malloc(len);</div><div class="line">	if (EXPECTED(tmp || !len)) &#123;</div><div class="line">		return tmp;</div><div class="line">	&#125;</div><div class="line">	zend_out_of_memory();</div><div class="line">&#125;</div><div class="line"></div><div class="line">ZEND_API void* ZEND_FASTCALL _safe_malloc(size_t nmemb, size_t size, size_t offset)</div><div class="line">&#123;</div><div class="line">	return pemalloc(zend_safe_address_guarded(nmemb, size, offset), 1);</div><div class="line">&#125;</div><div class="line"></div><div class="line">ZEND_API void * __zend_calloc(size_t nmemb, size_t len)</div><div class="line">&#123;</div><div class="line">	void *tmp = _safe_malloc(nmemb, len, 0);</div><div class="line">	memset(tmp, 0, nmemb * len); </div><div class="line"></div><div class="line">	return tmp;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到， 无论是_safe_malloc，还是<strong>zend_calloc，持久化方式最终调用的都是</strong>zend_malloc，而<strong>zend_malloc内部调用的malloc来进行内存的分配，其中</strong>zend_calloc和_safe_malloc的区别仅仅在于是否初始化内存空间为0</p>
<h2 id="非持久化内存"><a href="#非持久化内存" class="headerlink" title="非持久化内存"></a>非持久化内存</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">#define emalloc(size)						_emalloc((size) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define emalloc_large(size)					_emalloc_large((size) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define emalloc_huge(size)					_emalloc_huge((size) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define safe_emalloc(nmemb, size, offset)	_safe_emalloc((nmemb), (size), (offset) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define efree(ptr)							_efree((ptr) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define efree_large(ptr)					_efree_large((ptr) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define efree_huge(ptr)						_efree_huge((ptr) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define ecalloc(nmemb, size)				_ecalloc((nmemb), (size) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define erealloc(ptr, size)					_erealloc((ptr), (size) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define erealloc2(ptr, size, copy_size)		_erealloc2((ptr), (size), (copy_size) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define safe_erealloc(ptr, nmemb, size, offset)	_safe_erealloc((ptr), (nmemb), (size), (offset) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define erealloc_recoverable(ptr, size)		_erealloc((ptr), (size) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define erealloc2_recoverable(ptr, size, copy_size) _erealloc2((ptr), (size), (copy_size) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define estrdup(s)							_estrdup((s) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define estrndup(s, length)					_estrndup((s), (length) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line">#define zend_mem_block_size(ptr)			_zend_mem_block_size((ptr) ZEND_FILE_LINE_CC ZEND_FILE_LINE_EMPTY_CC)</div><div class="line"></div><div class="line">/* Relay wrapper macros */</div><div class="line">#define emalloc_rel(size)						_emalloc((size) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_CC)</div><div class="line">#define safe_emalloc_rel(nmemb, size, offset)	_safe_emalloc((nmemb), (size), (offset) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_CC)</div><div class="line">#define efree_rel(ptr)							_efree((ptr) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_CC)</div><div class="line">#define ecalloc_rel(nmemb, size)				_ecalloc((nmemb), (size) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_CC)</div><div class="line">#define erealloc_rel(ptr, size)					_erealloc((ptr), (size) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_CC)</div><div class="line">#define erealloc2_rel(ptr, size, copy_size)		_erealloc2((ptr), (size), (copy_size) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_CC)</div><div class="line">#define erealloc_recoverable_rel(ptr, size)		_erealloc((ptr), (size) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_CC)</div><div class="line">#define erealloc2_recoverable_rel(ptr, size, copy_size) _erealloc2((ptr), (size), (copy_size) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_CC)</div><div class="line">#define safe_erealloc_rel(ptr, nmemb, size, offset)	_safe_erealloc((ptr), (nmemb), (size), (offset) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_CC)</div><div class="line">#define estrdup_rel(s)							_estrdup((s) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_CC)</div><div class="line">#define estrndup_rel(s, length)					_estrndup((s), (length) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_CC)</div><div class="line">#define zend_mem_block_size_rel(ptr)			_zend_mem_block_size((ptr) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_CC)</div><div class="line"></div><div class="line">ZEND_API void* ZEND_FASTCALL _emalloc(size_t size ZEND_FILE_LINE_DC ZEND_FILE_LINE_ORIG_DC)</div><div class="line">&#123;</div><div class="line"></div><div class="line">#if ZEND_MM_CUSTOM</div><div class="line">	if (UNEXPECTED(AG(mm_heap)-&gt;use_custom_heap)) &#123;</div><div class="line">		if (ZEND_DEBUG &amp;&amp; AG(mm_heap)-&gt;use_custom_heap == ZEND_MM_CUSTOM_HEAP_DEBUG) &#123;</div><div class="line">			return AG(mm_heap)-&gt;custom_heap.debug._malloc(size ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_ORIG_RELAY_CC);</div><div class="line">		&#125; else &#123;</div><div class="line">			return AG(mm_heap)-&gt;custom_heap.std._malloc(size);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">#endif</div><div class="line">	return zend_mm_alloc_heap(AG(mm_heap), size ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_ORIG_RELAY_CC);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里可以看到，非持久化方式，使用zend_mm_alloc_heap，来分配heap的空间，其中根据size的不同有3中分配方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">...........</div><div class="line">if (size &lt;= ZEND_MM_MAX_SMALL_SIZE) &#123;</div><div class="line">		ptr = zend_mm_alloc_small(heap, size, ZEND_MM_SMALL_SIZE_TO_BIN(size) ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_ORIG_RELAY_CC);</div><div class="line">............</div><div class="line">	&#125; else if (size &lt;= ZEND_MM_MAX_LARGE_SIZE) &#123;</div><div class="line">		ptr = zend_mm_alloc_large(heap, size ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_ORIG_RELAY_CC);</div><div class="line">............</div><div class="line">		return ptr;</div><div class="line">	&#125; else &#123;</div><div class="line">............</div><div class="line">		return zend_mm_alloc_huge(heap, size ZEND_FILE_LINE_RELAY_CC ZEND_FILE_LINE_ORIG_RELAY_CC);</div><div class="line">	&#125;</div><div class="line">..........</div></pre></td></tr></table></figure></p>
<p>也就是<br>(0, ZEND_MM_MAX_SMALL_SIZE]<br>(ZEND_MM_MAX_SMALL_SIZE, ZEND_MM_MAX_LARGE_SIZE]<br>(ZEND_MM_MAX_LARGE_SIZE, ZEND_MM_PAGE_SIZE]<br>这里还需要注意的是storage层，并不是指zend_mm_storage对象，需要区分开，从源码看zend_mm_storage只会跟PHPDBG有关，PHPDBG是什么呢？</p>
<h1 id="PHPDBG"><a href="#PHPDBG" class="headerlink" title="PHPDBG"></a>PHPDBG</h1><p>   PHPDBG是一个PHP的SAPI模块，可以在不用修改代码和不影响性能的情况下控制PHP的运行环境。PHPDBG的目标是成为一个轻量级、强大、易用的PHP调试平台。可以在PHP5.4和之上版本中使用。在php5.6和之上版本将内部集成。</p>
<p>主要功能：</p>
<ul>
<li>单步调试</li>
<li>灵活的下断点方式（类方法、函数、文件:行、内存地址、opcode）</li>
<li>可直接调用php的eval</li>
<li>可以查看当前执行的代码</li>
<li>用户空间API（userland/user space）</li>
<li>方便集成</li>
<li>支持指定php配置文件</li>
<li>JIT全局变量</li>
<li>readline支持（可选），终端操作更方便</li>
<li>远程debug，使用java GUI</li>
<li>操作简便（具体看help）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">root@chenjingxiu:~# phptest/bin/phpdbg </div><div class="line">[Welcome to phpdbg, the interactive PHP debugger, v0.5.0]</div><div class="line">To get help using phpdbg type &quot;help&quot; and press enter</div><div class="line">[Please report bugs to &lt;http://bugs.php.net/report.php&gt;]</div><div class="line">prompt&gt; exec a.php</div><div class="line">[Set execution context: /home/chenjingxiu/a.php]</div><div class="line">[Successful compilation of /home/chenjingxiu/a.php]</div><div class="line">prompt&gt; b fun</div><div class="line">[Breakpoint #0 added at fun]</div><div class="line">prompt&gt; r</div><div class="line">[Script ended normally]</div><div class="line">[Mon Jul 17 19:23:36 2017]  Script:  &apos;-&apos;</div><div class="line">/home/chenjingxiu/php-src/sapi/phpdbg/phpdbg.c(1799) :  Freeing 0xb7204018 (1 bytes), script=-</div><div class="line">=== Total 1 memory leaks detected ===</div><div class="line">prompt&gt;</div></pre></td></tr></table></figure>
<p>很像gdb是不？转回正题</p>
<h1 id="php内存管理"><a href="#php内存管理" class="headerlink" title="php内存管理"></a>php内存管理</h1>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/07/07/php垃圾回收/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/07/php垃圾回收/" itemprop="url">
                  Php垃圾回收
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-07T23:10:23+08:00">
                2017-07-07
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="zend-gc-globals结构体"><a href="#zend-gc-globals结构体" class="headerlink" title="zend_gc_globals结构体"></a>zend_gc_globals结构体</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">typedef struct _zend_gc_globals &#123;</div><div class="line">        zend_bool         gc_enabled;</div><div class="line">        zend_bool         gc_active;</div><div class="line">        zend_bool         gc_full;</div><div class="line"></div><div class="line">        gc_root_buffer   *buf;                          /* preallocated arrays of buffers   */</div><div class="line">        gc_root_buffer    roots;                        /* list of possible roots of cycles */</div><div class="line">        gc_root_buffer   *unused;                       /* list of unused buffers           */</div><div class="line">        gc_root_buffer   *first_unused;         /* pointer to first unused buffer   */</div><div class="line">        gc_root_buffer   *last_unused;          /* pointer to last unused buffer    */</div><div class="line"></div><div class="line">        gc_root_buffer    to_free;                      /* list to free                     */</div><div class="line">        gc_root_buffer   *next_to_free;</div><div class="line"></div><div class="line">        uint32_t gc_runs;</div><div class="line">        uint32_t collected;</div><div class="line"></div><div class="line">#if GC_BENCH</div><div class="line">        uint32_t root_buf_length;</div><div class="line">        uint32_t root_buf_peak;</div><div class="line">        uint32_t zval_possible_root;</div><div class="line">        uint32_t zval_buffered;</div><div class="line">        uint32_t zval_remove_from_buffer;</div><div class="line">        uint32_t zval_marked_grey;</div><div class="line">#endif</div><div class="line"></div><div class="line">        gc_additional_buffer *additional_buffer;</div><div class="line"></div><div class="line">&#125; zend_gc_globals;</div></pre></td></tr></table></figure>
<p>说明:<br>   gc_enabled  是否开启了GC<br>   gc_active   是否GC正在运行<br>   gc_full     GC缓冲区是否已经满le<br>   buf         预分配总的缓冲区大小<br>   roots       可能需要回收对象列表<br>   unused      未使用的缓存区<br>   first_unused 未使用的缓冲区的第一个元素<br>   last_unused  未使用的缓冲区的最后一个元素<br>   to_free      垃圾列表<br>   next_to_free 指一个垃圾列表元素<br>   gc_runs      GC运行次数<br>   collected    是否垃圾收集完成<br>   additional_buffer 其它缓冲区</p>
<h1 id="GC初始化gc-globals"><a href="#GC初始化gc-globals" class="headerlink" title="GC初始化gc_globals"></a>GC初始化gc_globals</h1><p>gc_globals_ctor  -&gt;  ts_allocate_id -&gt;  gc_globals_ctor_ex</p>
<p>```</p>
<p>ZEND_API void gc_globals_ctor(void)<br>{</p>
<p>#ifdef ZTS<br>        ts_allocate_id(&amp;gc_globals_id, sizeof(zend_gc_globals), (ts_allocate_ctor) gc_globals_ctor_ex, (ts_allocate_dtor) root_buffer_dtor);</p>
<p>#else<br>        gc_globals_ctor_ex(&amp;gc_globals);</p>
<p>#endif<br>}</p>
<p>参数说明:<br>rsrc_id  全局资源id (int型)<br>size     资源大小<br>ctor     构造器<br>dtor     析构器</p>
<p>TSRM_API ts_rsrc_id ts_allocate_id(ts_rsrc_id <em>rsrc_id, size_t size, ts_allocate_ctor ctor, ts_allocate_dtor dtor)<br>{<br>        int i;<br>        TSRM_ERROR((TSRM_ERROR_LEVEL_CORE, “Obtaining a new resource id, %d bytes”, size));<br>        /</em> 加互斥锁 <em>/<br>        tsrm_mutex_lock(tsmm_mutex);<br>        /</em> 生成全局资源id  <em>/
        </em>rsrc_id = TSRM_SHUFFLE_RSRC_ID(id_count++);<br>        TSRM_ERROR((TSRM_ERROR_LEVEL_CORE, “Obtained resource id %d”, <em>rsrc_id));<br>        /</em> 注册新的资源到全局资源表 <em>/<br>        if (resource_types_table_size &lt; id_count) { /</em> 如果资源表的大小太小，则调整资源表的大小 <em>/<br>                /</em> 扩展资源表的内存空间 <em>/<br>                resource_types_table = (tsrm_resource_type </em>) realloc(resource_types_table, sizeof(tsrm_resource_type)<em>id_count);<br>                /</em>  如果内存分配失败，解锁并返回 <em>/<br>                if (!resource_types_table) {<br>                        tsrm_mutex_unlock(tsmm_mutex);<br>                        TSRM_ERROR((TSRM_ERROR_LEVEL_ERROR, “Unable to allocate storage for resource”));
                        </em>rsrc_id = 0;<br>                        return 0;<br>                }<br>                /<em> 如果分配成功，则修改资源表的大小 </em>/<br>                resource_types_table_size = id_count;<br>        }<br>        /<em> 注册全局资源对象 </em>/<br>        resource_types_table[TSRM_UNSHUFFLE_RSRC_ID(<em>rsrc_id)].size = size;<br>        resource_types_table[TSRM_UNSHUFFLE_RSRC_ID(</em>rsrc_id)].ctor = ctor;<br>        resource_types_table[TSRM_UNSHUFFLE_RSRC_ID(<em>rsrc_id)].dtor = dtor;<br>        resource_types_table[TSRM_UNSHUFFLE_RSRC_ID(</em>rsrc_id)].done = 0;<br>        /<em> 遍历线程表，同步全局资源到各个线程对象 </em>/<br>         for (i=0; i<tsrm_tls_table_size; i++)="" {="" *="" 读取tsrm_tls_entry线程对象链表头指针="" tsrm_tls_entry="" *p="tsrm_tls_table[i];" 遍历线程链表="" while="" (p)="" 如果线程中的资源数跟全局资源表中的数量不一致，则更新线程资源数据表="" if="" (p-="">count &lt; id_count) {<br>                                int j;<br>                                /<em> 扩展线程资源数据内存空间 </em>/<br>                                p-&gt;storage = (void <em>) realloc(p-&gt;storage, sizeof(void </em>)<em>id_count);<br>                                /</em> 新增资源分配内存空间 <em>/<br>                                for (j=p-&gt;count; j<id_count; j++)="" {="" p-="">storage[j] = (void </id_count;></em>) malloc(resource_types_table[j].size);<br>                                        if (resource_types_table[j].ctor) {<br>                                                /<em> 调用构造器，初始化gc_globals对象 </em>/<br>                                                resource_types_table[j].ctor(p-&gt;storage[j]);<br>                                        }<br>                                }<br>                                /<em> 修改线程资源数量 </em>/<br>                                p-&gt;count = id_count;<br>                        }<br>                        /<em> 同步下一个线程对象 </em>/<br>                        p = p-&gt;next;<br>                }<br>        }<br>        /<em> 资源初始化完毕，解锁 </em>/<br>        tsrm_mutex_unlock(tsmm_mutex);<br>        TSRM_ERROR((TSRM_ERROR_LEVEL_CORE, “Successfully allocated new resource id %d”, <em>rsrc_id));<br>        /</em> 全局资源id <em>/<br>        return </em>rsrc_id;<br>}</tsrm_tls_table_size;></p>
<p>/<em> 初始化gc_globals对象 </em>/<br>static void gc_globals_ctor_ex(zend_gc_globals *gc_globals)<br>{<br>        gc_globals-&gt;gc_enabled = 0;<br>        gc_globals-&gt;gc_active = 0;</p>
<pre><code>gc_globals-&gt;buf = NULL;

gc_globals-&gt;roots.next = &amp;gc_globals-&gt;roots;
gc_globals-&gt;roots.prev = &amp;gc_globals-&gt;roots;
gc_globals-&gt;unused = NULL;
gc_globals-&gt;next_to_free = NULL;

gc_globals-&gt;to_free.next = &amp;gc_globals-&gt;to_free;
gc_globals-&gt;to_free.prev = &amp;gc_globals-&gt;to_free;

gc_globals-&gt;gc_runs = 0;
gc_globals-&gt;collected = 0;

gc_globals-&gt;additional_buffer = NULL;
</code></pre><p>#if GC_BENCH<br>        gc_globals-&gt;root_buf_length = 0;<br>        gc_globals-&gt;root_buf_peak = 0;<br>        gc_globals-&gt;zval_possible_root = 0;<br>        gc_globals-&gt;zval_buffered = 0;<br>        gc_globals-&gt;zval_remove_from_buffer = 0;<br>        gc_globals-&gt;zval_marked_grey = 0;</p>
<p>#endif<br>}</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/07/05/Mysql索引/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/05/Mysql索引/" itemprop="url">
                  Mysql in , not in, !=  索引和插入
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-05T23:00:00+08:00">
                2017-07-05
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天来看下mysql中的in，not in索引的使用，首先创建一张表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `User` (</div><div class="line">  `id` int(10) NOT NULL AUTO_INCREMENT,</div><div class="line">  `username` varchar(100) NOT NULL DEFAULT &apos;&apos;,</div><div class="line">  `age` int(10) NOT NULL,</div><div class="line">  PRIMARY KEY (`id`),</div><div class="line">  KEY `idx_username` (`username`)</div><div class="line">) ENGINE=MyISAM AUTO_INCREMENT=6 DEFAULT CHARSET=utf8</div><div class="line"></div><div class="line">insert into User values(1,&quot;a&quot;,10);</div><div class="line">insert into User values(2,&quot;b&quot;,20);</div><div class="line">insert into User values(3,&quot;c&quot;,30);</div><div class="line">insert into User values(4,&quot;d&quot;,40);</div><div class="line">insert into User values(5,&quot;e&quot;,50);</div></pre></td></tr></table></figure></p>
<p>使用explain查看索引的使用情况<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">mysql&gt; explain select * from User where username in (&quot;a&quot;,&quot;b&quot;) order by username;</div><div class="line">+----+-------------+-------+------------+-------+---------------+--------------+---------+------+------+----------+-----------------------+</div><div class="line">| id | select_type | table | partitions | type  | possible_keys | key          | key_len | ref  | rows | filtered | Extra                 |</div><div class="line">+----+-------------+-------+------------+-------+---------------+--------------+---------+------+------+----------+-----------------------+</div><div class="line">|  1 | SIMPLE      | User  | NULL       | range | idx_username  | idx_username | 302     | NULL |    2 |   100.00 | Using index condition |</div><div class="line">+----+-------------+-------+------------+-------+---------------+--------------+---------+------+------+----------+-----------------------+</div><div class="line">1 row in set, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; explain select * from User where username in(&quot;a&quot;);</div><div class="line">+----+-------------+-------+------------+------+---------------+--------------+---------+-------+------+----------+-------+</div><div class="line">| id | select_type | table | partitions | type | possible_keys | key          | key_len | ref   | rows | filtered | Extra |</div><div class="line">+----+-------------+-------+------------+------+---------------+--------------+---------+-------+------+----------+-------+</div><div class="line">|  1 | SIMPLE      | User  | NULL       | ref  | idx_username  | idx_username | 302     | const |    1 |   100.00 | NULL  |</div><div class="line">+----+-------------+-------+------------+------+---------------+--------------+---------+-------+------+----------+-------+</div><div class="line">1 row in set, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; explain select * from User where username not in (&quot;a&quot;,&quot;b&quot;) order by username;</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                       |</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</div><div class="line">|  1 | SIMPLE      | User  | NULL       | ALL  | idx_username  | NULL | NULL    | NULL |    5 |   100.00 | Using where; Using filesort |</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-----------------------------+</div><div class="line">1 row in set, 1 warning (0.02 sec)</div><div class="line"></div><div class="line">mysql&gt; explain select * from User where username !=&quot;a&quot;;</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</div><div class="line">|  1 | SIMPLE      | User  | NULL       | ALL  | idx_username  | NULL | NULL    | NULL |    5 |   100.00 | Using where |</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</div><div class="line">1 row in set, 1 warning (0.01 sec)</div></pre></td></tr></table></figure></p>
<p>可以看到在MYISAM存储引擎下，in无论怎样都使用了索引，而not int没有使用索引，!=没有使用索引，现在将MYISAM换成INNODB<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">alter table User engine=innodb</div></pre></td></tr></table></figure></p>
<p>然后执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">mysql&gt; explain select * from User where username in(&quot;a&quot;);</div><div class="line">+----+-------------+-------+------------+------+---------------+--------------+---------+-------+------+----------+-------+</div><div class="line">| id | select_type | table | partitions | type | possible_keys | key          | key_len | ref   | rows | filtered | Extra |</div><div class="line">+----+-------------+-------+------------+------+---------------+--------------+---------+-------+------+----------+-------+</div><div class="line">|  1 | SIMPLE      | User  | NULL       | ref  | idx_username  | idx_username | 302     | const |    1 |   100.00 | NULL  |</div><div class="line">+----+-------------+-------+------------+------+---------------+--------------+---------+-------+------+----------+-------+</div><div class="line">1 row in set, 1 warning (0.06 sec)</div><div class="line"></div><div class="line">mysql&gt; explain select * from User where username in (&quot;a&quot;,&quot;b&quot;);</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</div><div class="line">|  1 | SIMPLE      | User  | NULL       | ALL  | idx_username  | NULL | NULL    | NULL |    5 |    40.00 | Using where |</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</div><div class="line">1 row in set, 1 warning (0.01 sec)</div><div class="line"></div><div class="line">mysql&gt; explain select * from User where username not in (&quot;a&quot;,&quot;b&quot;);</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</div><div class="line">|  1 | SIMPLE      | User  | NULL       | ALL  | idx_username  | NULL | NULL    | NULL |    5 |   100.00 | Using where |</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</div><div class="line">1 row in set, 1 warning (0.00 sec)</div><div class="line"></div><div class="line">mysql&gt; explain select * from User where username !=&quot;a&quot;;</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</div><div class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</div><div class="line">|  1 | SIMPLE      | User  | NULL       | ALL  | idx_username  | NULL | NULL    | NULL |    5 |   100.00 | Using where |</div><div class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+-------------+</div><div class="line">1 row in set, 1 warning (0.01 sec)</div></pre></td></tr></table></figure></p>
<p>结构发现INNODB存储引擎，只有当in中只有一个元素时，才会使用索引，其它情况都不使用索引，而not in不会使用索引，!=也不会使用索引，也就是INNODB中in中只有一个元素的时候跟等号操作符一样, order by 不会使用索引!</p>
<h1 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">insert into tb (...) values(...),(...)...;</div><div class="line">insert into tb (...) values (...);insert into tb (...) values (...);...</div></pre></td></tr></table></figure>
<p>当要插入10w条那个快？当然是第一个！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/07/04/PHP中的线程/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/04/PHP中的线程/" itemprop="url">
                  PHP中的线程
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-04T23:00:00+08:00">
                2017-07-04
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="线程安全ZTS"><a href="#线程安全ZTS" class="headerlink" title="线程安全ZTS"></a>线程安全ZTS</h1><p>这个宏是需要在编译的时候指定了，才会生成的。其中configure文件中有下面的一行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$as_echo &quot;#define ZTS 1&quot; &gt;&gt;confdefs.h</div></pre></td></tr></table></figure></p>
<p>说明只有当TSRM被启用的时候，就会定义这个名为ZTS的宏</p>
<h1 id="线程安全资源管理器-Thread-Safe-Resource-Manager-TSRM"><a href="#线程安全资源管理器-Thread-Safe-Resource-Manager-TSRM" class="headerlink" title="线程安全资源管理器(Thread Safe Resource Manager)TSRM"></a>线程安全资源管理器(Thread Safe Resource Manager)TSRM</h1><p>在写PHP扩展的时候经常使用的宏，先看下相关的宏的定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#ifdef ZTS</div><div class="line">#define TSRMLS_D void ***tsrm_ls</div><div class="line">#define TSRMLS_DC , TSRMLS_D</div><div class="line">#define TSRMLS_C tsrm_ls</div><div class="line">#define TSRMLS_CC , TSRMLS_C</div><div class="line">#else</div><div class="line">#define TSRMLS_D void</div><div class="line">#define TSRMLS_DC</div><div class="line">#define TSRMLS_C</div><div class="line">#define TSRMLS_CC</div><div class="line">#endif</div></pre></td></tr></table></figure></p>
<p>发现这些宏都跟tsrm_ls是相关的，找到sapi/fpm/fpm/fpm_main.c中1583行和1612行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">void ***tsrm_ls;</div><div class="line">tsrm_ls = ts_resource(0);</div></pre></td></tr></table></figure></p>
<p>TSRM/TSRM.h文件112行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#define ts_resource(id)			ts_resource_ex(id, NULL)</div></pre></td></tr></table></figure></p>
<p>最终定位到ts_resource_ex这个函数，现在看下这个函数是如何实现的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div></pre></td><td class="code"><pre><div class="line">/* 线程指针表头指针 */</div><div class="line">static tsrm_tls_entry   **tsrm_tls_table = NULL</div><div class="line">/* 线程数量 */</div><div class="line">static int  tsrm_tls_table_size; </div><div class="line">/* 初始化线程表 */</div><div class="line">tsrm_tls_table = (tsrm_tls_entry **) calloc(tsrm_tls_table_size, sizeof(tsrm_tls_entry *));</div><div class="line"></div><div class="line">typedef struct _tsrm_tls_entry tsrm_tls_entry;</div><div class="line"></div><div class="line">/*  线程结构体 */</div><div class="line">struct _tsrm_tls_entry &#123;</div><div class="line">        void **storage;       //  资源指针、就是指向自己的公共资源内存区</div><div class="line">        int count;            //  资源数、就是 PHP内核 + 扩展模块 共注册了多少公共资源</div><div class="line">        THREAD_T thread_id;   //  线程id</div><div class="line">        tsrm_tls_entry *next; //  指向下一个线程指针，当前每一个线程指针都存在一个线程指针表里（类似于hash表），这个next可以理解成是hash冲突链式解决法</div><div class="line">&#125;;</div><div class="line"></div><div class="line">/* 资源类型 */</div><div class="line">typedef struct &#123;</div><div class="line">    size_t size;              //  资源大小</div><div class="line">    ts_allocate_ctor ctor;    //  构造函数指针、在给每一个线程创建该资源的时候会调用一下当前ctor指针</div><div class="line">    ts_allocate_dtor dtor;    //  析构函数指针、释放该资源的时候会调用一下当前dtor指针</div><div class="line">    int done;                 //  资源是否已经销毁 0:正常 1:已销毁</div><div class="line">&#125; tsrm_resource_type;</div><div class="line"></div><div class="line">static tsrm_resource_type \*resource_types_table=NULL; // 公共资源类型表头指针</div><div class="line">static int  resource_types_table_size;                 // 当前公共资源类型数量</div><div class="line"></div><div class="line">/* 全局资源 注册资源时给每一个资源生成一个唯一id，获取时根据该唯一id进行获取 */</div><div class="line">/* 每个线程都会把当前注册的所有公共资源全部copy一份过来，也就是一个malloc()一个大数组，这个资源id就是该数组的索引 */</div><div class="line">/* 然后需要公共资源时，通过资源id来读取即可 */</div><div class="line">typedef int ts_rsrc_id;</div><div class="line">static ts_rsrc_id id_count;</div><div class="line"></div><div class="line">/*####################  线程管理 #####################*/</div><div class="line">/*#  1. tsrm_startup()                               #*/</div><div class="line">/*#  2. ts_allocate_id()                             #*/ </div><div class="line">/*#  3. ts_reaource(id)                              #*/  </div><div class="line">/*#  4. allocate_new_resource()                      #*/</div><div class="line">/*#  5. tsrm_shutdown()                              #*/</div><div class="line">/*####################################################*/</div><div class="line"></div><div class="line">//1. 内核初始化 tsrm_startup() Startup TSRM (call once for the entire process) </div><div class="line">TSRM_API int tsrm_startup(int expected_threads, int expected_resources, int debug_level, char *debug_filename)</div><div class="line">&#123;</div><div class="line">#if defined(GNUPTH)</div><div class="line">        pth_init();</div><div class="line">#elif defined(PTHREADS)</div><div class="line">        pthread_key_create( &amp;tls_key, 0 );</div><div class="line">#elif defined(TSRM_ST)</div><div class="line">        st_init();</div><div class="line">        st_key_create(&amp;tls_key, 0);</div><div class="line">#elif defined(TSRM_WIN32)</div><div class="line">        tls_key = TlsAlloc();</div><div class="line">#elif defined(BETHREADS)</div><div class="line">        tls_key = tls_allocate();</div><div class="line">#endif</div><div class="line"></div><div class="line">        /* ensure singleton */</div><div class="line">        in_main_thread = 1;</div><div class="line"></div><div class="line">        tsrm_error_file = stderr;</div><div class="line">        tsrm_error_set(debug_level, debug_filename);</div><div class="line">        tsrm_tls_table_size = expected_threads;</div><div class="line"></div><div class="line">        tsrm_tls_table = (tsrm_tls_entry **) calloc(tsrm_tls_table_size, sizeof(tsrm_tls_entry *));</div><div class="line">        if (!tsrm_tls_table) &#123;</div><div class="line">                TSRM_ERROR((TSRM_ERROR_LEVEL_ERROR, &quot;Unable to allocate TLS table&quot;));</div><div class="line">                return 0;</div><div class="line">        &#125;</div><div class="line">        id_count=0;</div><div class="line"></div><div class="line">        resource_types_table_size = expected_resources;</div><div class="line">        resource_types_table = (tsrm_resource_type *) calloc(resource_types_table_size, sizeof(tsrm_resource_type));</div><div class="line">        if (!resource_types_table) &#123;</div><div class="line">                TSRM_ERROR((TSRM_ERROR_LEVEL_ERROR, &quot;Unable to allocate resource types table&quot;));</div><div class="line">                free(tsrm_tls_table);</div><div class="line">                tsrm_tls_table = NULL;</div><div class="line">                return 0;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        tsmm_mutex = tsrm_mutex_alloc();</div><div class="line"></div><div class="line">        TSRM_ERROR((TSRM_ERROR_LEVEL_CORE, &quot;Started up TSRM, %d expected threads, %d expected resources&quot;, expected_threads, expected_resources));</div><div class="line">        return 1;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//2. 注册公共资源 ts_allocate_id() allocates a new thread-safe-resource id</div><div class="line">TSRM_API ts_rsrc_id ts_allocate_id(ts_rsrc_id *rsrc_id, size_t size, ts_allocate_ctor ctor, ts_allocate_dtor dtor)</div><div class="line">&#123;</div><div class="line">        int i;</div><div class="line"></div><div class="line">        TSRM_ERROR((TSRM_ERROR_LEVEL_CORE, &quot;Obtaining a new resource id, %d bytes&quot;, size));</div><div class="line"></div><div class="line">        tsrm_mutex_lock(tsmm_mutex);</div><div class="line"></div><div class="line">        /* obtain a resource id */</div><div class="line">        *rsrc_id = TSRM_SHUFFLE_RSRC_ID(id_count++);</div><div class="line">        TSRM_ERROR((TSRM_ERROR_LEVEL_CORE, &quot;Obtained resource id %d&quot;, *rsrc_id));</div><div class="line"></div><div class="line">        /* store the new resource type in the resource sizes table */</div><div class="line">        if (resource_types_table_size &lt; id_count) &#123;</div><div class="line">                resource_types_table = (tsrm_resource_type *) realloc(resource_types_table, sizeof(tsrm_resource_type)*id_count);</div><div class="line">                if (!resource_types_table) &#123;</div><div class="line">                        tsrm_mutex_unlock(tsmm_mutex);</div><div class="line">                        TSRM_ERROR((TSRM_ERROR_LEVEL_ERROR, &quot;Unable to allocate storage for resource&quot;));</div><div class="line">                        *rsrc_id = 0;</div><div class="line">                        return 0;</div><div class="line">                &#125;</div><div class="line">                resource_types_table_size = id_count;</div><div class="line">        &#125;</div><div class="line">        resource_types_table[TSRM_UNSHUFFLE_RSRC_ID(*rsrc_id)].size = size;</div><div class="line">        resource_types_table[TSRM_UNSHUFFLE_RSRC_ID(*rsrc_id)].ctor = ctor;</div><div class="line">        resource_types_table[TSRM_UNSHUFFLE_RSRC_ID(*rsrc_id)].dtor = dtor;</div><div class="line">        resource_types_table[TSRM_UNSHUFFLE_RSRC_ID(*rsrc_id)].done = 0;</div><div class="line"></div><div class="line">        /* enlarge the arrays for the already active threads */</div><div class="line">         for (i=0; i&lt;tsrm_tls_table_size; i++) &#123;</div><div class="line">                tsrm_tls_entry *p = tsrm_tls_table[i];</div><div class="line"></div><div class="line">                while (p) &#123;</div><div class="line">                        if (p-&gt;count &lt; id_count) &#123;</div><div class="line">                                int j;</div><div class="line"></div><div class="line">                                p-&gt;storage = (void *) realloc(p-&gt;storage, sizeof(void *)*id_count);</div><div class="line">                                for (j=p-&gt;count; j&lt;id_count; j++) &#123;</div><div class="line">                                        p-&gt;storage[j] = (void *) malloc(resource_types_table[j].size);</div><div class="line">                                        if (resource_types_table[j].ctor) &#123;</div><div class="line">                                                resource_types_table[j].ctor(p-&gt;storage[j]);</div><div class="line">                                        &#125;</div><div class="line">                                &#125;</div><div class="line">                                p-&gt;count = id_count;</div><div class="line">                        &#125;</div><div class="line">                        p = p-&gt;next;</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">        tsrm_mutex_unlock(tsmm_mutex);</div><div class="line"></div><div class="line">        TSRM_ERROR((TSRM_ERROR_LEVEL_CORE, &quot;Successfully allocated new resource id %d&quot;, *rsrc_id));</div><div class="line">        return *rsrc_id;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 3. 读取公共资源 ts_reaource(id) fetches the requested resource for the current thread</div><div class="line">TSRM_API void *ts_resource_ex(ts_rsrc_id id, THREAD_T *th_id)</div><div class="line">&#123;</div><div class="line">        THREAD_T thread_id;</div><div class="line">        int hash_value;</div><div class="line">        tsrm_tls_entry *thread_resources;</div><div class="line"></div><div class="line">        if (!th_id) &#123;</div><div class="line">                /* Fast path for looking up the resources for the current</div><div class="line">                 * thread. Its used by just about every call to</div><div class="line">                 * ts_resource_ex(). This avoids the need for a mutex lock</div><div class="line">                 * and our hashtable lookup.</div><div class="line">                 */</div><div class="line">                thread_resources = tsrm_tls_get();</div><div class="line"></div><div class="line">                if (thread_resources) &#123;</div><div class="line">                        TSRM_ERROR((TSRM_ERROR_LEVEL_INFO, &quot;Fetching resource id %d for current thread %d&quot;, id, (long) thread_resources-&gt;thread_id));</div><div class="line">                        /* Read a specific resource from the thread&apos;s resources.</div><div class="line">                         * This is called outside of a mutex, so have to be aware about external</div><div class="line">                         * changes to the structure as we read it.</div><div class="line">                         */</div><div class="line">                        TSRM_SAFE_RETURN_RSRC(thread_resources-&gt;storage, id, thread_resources-&gt;count);</div><div class="line">                &#125;</div><div class="line">                thread_id = tsrm_thread_id();</div><div class="line">        &#125; else &#123;</div><div class="line">                thread_id = *th_id;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        TSRM_ERROR((TSRM_ERROR_LEVEL_INFO, &quot;Fetching resource id %d for thread %ld&quot;, id, (long) thread_id));</div><div class="line">        tsrm_mutex_lock(tsmm_mutex);</div><div class="line"></div><div class="line">        hash_value = THREAD_HASH_OF(thread_id, tsrm_tls_table_size);</div><div class="line">        thread_resources = tsrm_tls_table[hash_value];</div><div class="line"></div><div class="line">        if (!thread_resources) &#123;</div><div class="line">                allocate_new_resource(&amp;tsrm_tls_table[hash_value], thread_id);</div><div class="line">                return ts_resource_ex(id, &amp;thread_id);</div><div class="line">        &#125; else &#123;</div><div class="line">                 do &#123;</div><div class="line">                        if (thread_resources-&gt;thread_id == thread_id) &#123;</div><div class="line">                                break;</div><div class="line">                        &#125;</div><div class="line">                        if (thread_resources-&gt;next) &#123;</div><div class="line">                                thread_resources = thread_resources-&gt;next;</div><div class="line">                        &#125; else &#123;</div><div class="line">                                allocate_new_resource(&amp;thread_resources-&gt;next, thread_id);</div><div class="line">                                return ts_resource_ex(id, &amp;thread_id);</div><div class="line">                                /*</div><div class="line">                                 * thread_resources = thread_resources-&gt;next;</div><div class="line">                                 * break;</div><div class="line">                                 */</div><div class="line">                        &#125;</div><div class="line">                 &#125; while (thread_resources);</div><div class="line">        &#125;</div><div class="line">        tsrm_mutex_unlock(tsmm_mutex);</div><div class="line">        /* Read a specific resource from the thread&apos;s resources.</div><div class="line">         * This is called outside of a mutex, so have to be aware about external</div><div class="line">         * changes to the structure as we read it.</div><div class="line">         */</div><div class="line">        TSRM_SAFE_RETURN_RSRC(thread_resources-&gt;storage, id, thread_resources-&gt;count);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 初始化当前线程 allocate_new_resource() </div><div class="line">static void allocate_new_resource(tsrm_tls_entry **thread_resources_ptr, THREAD_T thread_id)</div><div class="line">&#123;</div><div class="line">        int i;</div><div class="line"></div><div class="line">        TSRM_ERROR((TSRM_ERROR_LEVEL_CORE, &quot;Creating data structures for thread %x&quot;, thread_id));</div><div class="line">        (*thread_resources_ptr) = (tsrm_tls_entry *) malloc(sizeof(tsrm_tls_entry));</div><div class="line">        (*thread_resources_ptr)-&gt;storage = NULL;</div><div class="line">        if (id_count &gt; 0) &#123;</div><div class="line">                (*thread_resources_ptr)-&gt;storage = (void **) malloc(sizeof(void *)*id_count);</div><div class="line">        &#125;</div><div class="line">        (*thread_resources_ptr)-&gt;count = id_count;</div><div class="line">        (*thread_resources_ptr)-&gt;thread_id = thread_id;</div><div class="line">        (*thread_resources_ptr)-&gt;next = NULL;</div><div class="line"></div><div class="line">        /* Set thread local storage to this new thread resources structure */</div><div class="line">        tsrm_tls_set(*thread_resources_ptr);</div><div class="line"></div><div class="line">        if (tsrm_new_thread_begin_handler) &#123;</div><div class="line">                tsrm_new_thread_begin_handler(thread_id);</div><div class="line">        &#125;</div><div class="line">        for (i=0; i&lt;id_count; i++) &#123;</div><div class="line">                if (resource_types_table[i].done) &#123;</div><div class="line">                        (*thread_resources_ptr)-&gt;storage[i] = NULL;</div><div class="line">                &#125; else</div><div class="line">                &#123;</div><div class="line">                        (*thread_resources_ptr)-&gt;storage[i] = (void *) malloc(resource_types_table[i].size);</div><div class="line">                        if (resource_types_table[i].ctor) &#123;</div><div class="line">                                resource_types_table[i].ctor((*thread_resources_ptr)-&gt;storage[i]);</div><div class="line">                        &#125;</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (tsrm_new_thread_end_handler) &#123;</div><div class="line">                tsrm_new_thread_end_handler(thread_id);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        tsrm_mutex_unlock(tsmm_mutex);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 注销线程资源tsrm_shutdown(void) Shutdown TSRM (call once for the entire process) </div><div class="line">TSRM_API void tsrm_shutdown(void)</div><div class="line">&#123;</div><div class="line">        int i;</div><div class="line"></div><div class="line">        if (!in_main_thread) &#123;</div><div class="line">                /* ensure singleton */</div><div class="line">                return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (tsrm_tls_table) &#123;</div><div class="line">                for (i=0; i&lt;tsrm_tls_table_size; i++) &#123;</div><div class="line">                        tsrm_tls_entry *p = tsrm_tls_table[i], *next_p;</div><div class="line"></div><div class="line">                        while (p) &#123;</div><div class="line">                                int j;</div><div class="line"></div><div class="line">                                next_p = p-&gt;next;</div><div class="line">                                for (j=0; j&lt;p-&gt;count; j++) &#123;</div><div class="line">                                        if (p-&gt;storage[j]) &#123;</div><div class="line">                                                if (resource_types_table &amp;&amp; !resource_types_table[j].done &amp;&amp; resource_types_table[j].dtor) &#123;</div><div class="line">                                                        resource_types_table[j].dtor(p-&gt;storage[j]);</div><div class="line">                                                &#125;</div><div class="line">                                                free(p-&gt;storage[j]);</div><div class="line">                                        &#125;</div><div class="line">                                &#125;</div><div class="line">                                free(p-&gt;storage);</div><div class="line">                                free(p);</div><div class="line">                                p = next_p;</div><div class="line">                        &#125;</div><div class="line">                &#125;</div><div class="line">                free(tsrm_tls_table);</div><div class="line">                tsrm_tls_table = NULL;</div><div class="line">        &#125;</div><div class="line">        if (resource_types_table) &#123;</div><div class="line">                free(resource_types_table);</div><div class="line">                resource_types_table=NULL;</div><div class="line">        &#125;</div><div class="line">        tsrm_mutex_free(tsmm_mutex);</div><div class="line">        tsmm_mutex = NULL;</div><div class="line">        TSRM_ERROR((TSRM_ERROR_LEVEL_CORE, &quot;Shutdown TSRM&quot;));</div><div class="line"> if (tsrm_error_file!=stderr) &#123;</div><div class="line">                fclose(tsrm_error_file);</div><div class="line">        &#125;</div><div class="line">#if defined(GNUPTH)</div><div class="line">        pth_kill();</div><div class="line">#elif defined(PTHREADS)</div><div class="line">        pthread_setspecific(tls_key, 0);</div><div class="line">        pthread_key_delete(tls_key);</div><div class="line">#elif defined(TSRM_WIN32)</div><div class="line">        TlsFree(tls_key);</div><div class="line">#endif</div><div class="line">        if (tsrm_shutdown_handler) &#123;</div><div class="line">                tsrm_shutdown_handler();</div><div class="line">        &#125;</div><div class="line">        tsrm_new_thread_begin_handler = NULL;</div><div class="line">        tsrm_new_thread_end_handler = NULL;</div><div class="line">        tsrm_shutdown_handler = NULL;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/07/03/几个线程函数的使用/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/07/03/几个线程函数的使用/" itemprop="url">
                  Thread local storage
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-07-03T23:54:43+08:00">
                2017-07-03
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><p>首先看下数据类型的分类，根据是单线程还是多线程，可以分为以下几类<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">全局数据</div><div class="line">局部数据</div><div class="line">线程特定数据(TSD)</div></pre></td></tr></table></figure></p>
<p>全局数据和局部数据比较好理解，但是线程特定数据是什么？独立于线程的数据，也就是说只有某个线程可以访问，其它线程不可以访问，实现某个线程内，函数调用之间的共享，也就是线程全局数据</p>
<h1 id="POSIX系统"><a href="#POSIX系统" class="headerlink" title="POSIX系统"></a>POSIX系统</h1><h2 id="KEY数据结构数组-至少128个TSD"><a href="#KEY数据结构数组-至少128个TSD" class="headerlink" title="KEY数据结构数组(至少128个TSD)"></a>KEY数据结构数组(至少128个TSD)</h2><table>
<thead>
<tr>
<th style="text-align:left">KEY数组</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">标志0</td>
</tr>
<tr>
<td style="text-align:left">析构函数指针0</td>
<td>—– &gt; 线程0   pthread_key_t </td>
</tr>
<tr>
<td style="text-align:left">标志1</td>
</tr>
<tr>
<td style="text-align:left">析构函数指针1</td>
<td>—– &gt; 线程1   pthread_key_t</td>
</tr>
<tr>
<td style="text-align:left">标志2</td>
</tr>
<tr>
<td style="text-align:left">析构函数指针2</td>
<td>—– &gt; 线程2   pthread_key_t</td>
</tr>
<tr>
<td style="text-align:left">………….</td>
</tr>
<tr>
<td style="text-align:left">标志127</td>
</tr>
<tr>
<td style="text-align:left">析构函数指针127</td>
<td>—– &gt; 线程127 pthread_key_t</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">标志: 是否已经被使用 (每次调用pthread_key_create创建一个新的TSD时，系统都会搜索key结构数组，找出其中未使用的元素，并通过pthread_key_t返回)</div><div class="line">析构函数指针: 指向一个析构函数，用户线程结束时后期处理（析构函数参数是一个指向TSD的指针）</div></pre></td></tr></table></figure>
<p>每一个TSD由标志字段和析构函数指针组成</p>
<h2 id="进程数据结构"><a href="#进程数据结构" class="headerlink" title="进程数据结构"></a>进程数据结构</h2><table>
<thead>
<tr>
<th style="text-align:left">Pthread结构</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">指针null</td>
</tr>
<tr>
<td style="text-align:left">指针null</td>
</tr>
<tr>
<td style="text-align:left">指针null</td>
</tr>
<tr>
<td style="text-align:left">………….</td>
</tr>
<tr>
<td style="text-align:left">指针null</td>
</tr>
</tbody>
</table>
<p>其中KEY数组中已分配的key的标志字段，都会跟Pthread结构相关联，而Pthread中存放指向实际数据的指针，也就是说进程维护KEY结构数组，而线程维护Pthread结构数组</p>
<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#include &lt;pthread.h&gt;</div><div class="line"></div><div class="line">/**</div><div class="line"> *param 1：一个键值指针</div><div class="line"> *param 2: 一个destructor函数，如果这个参数不为空，那么每当线程结束时，系统将调用这个函数来释放绑定在这个键上的内存快</div><div class="line"> **/</div><div class="line">int pthread_key_create(pthread_key_t *key, void (*destructor)(void*));</div><div class="line">/* 注销一个TSMG_STATIC(id, type, element)	   </div><div class="line">                              (TSRMG_BULK_STATIC(id, type)→element)</div><div class="line">int pthread_key_delete(pthread_key_t key);</div><div class="line">/* 读取变量的地址 */</div><div class="line">void *pthread_getspecific(pthread_key_t key);</div><div class="line">/* 存储变量的地址， 将普通变量转换成TSD */</div><div class="line">int pthread_setspecific(pthread_key_t key, const void *value);</div></pre></td></tr></table></figure>
<h1 id="PHP中的多线程"><a href="#PHP中的多线程" class="headerlink" title="PHP中的多线程"></a>PHP中的多线程</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">/* Thread local storage */</div><div class="line">static pthread_key_t tls_key;</div><div class="line"># define tsrm_tls_set(what)             pthread_setspecific(tls_key, (void*)(what))</div><div class="line"># define tsrm_tls_get()                 pthread_getspecific(tls_key)</div><div class="line"></div><div class="line">#elif defined(TSRM_ST)</div><div class="line">static int tls_key;</div><div class="line"># define tsrm_tls_set(what)             st_thread_setspecific(tls_key, (void*)(what))</div><div class="line"># define tsrm_tls_get()                 st_thread_getspecific(tls_key)</div><div class="line"></div><div class="line">#elif defined(TSRM_WIN32)</div><div class="line">static DWORD tls_key;</div><div class="line"># define tsrm_tls_set(what)             TlsSetValue(tls_key, (void*)(what))</div><div class="line"># define tsrm_tls_get()                 TlsGetValue(tls_key)</div><div class="line"></div><div class="line">#elif defined(BETHREADS)</div><div class="line">static int32 tls_key;</div><div class="line"># define tsrm_tls_set(what)             tls_set(tls_key, (void*)(what))</div><div class="line"># define tsrm_tls_get()                 (tsrm_tls_entry*)tls_get(tls_key)</div><div class="line"></div><div class="line">#else</div><div class="line"># define tsrm_tls_set(what)</div><div class="line"># define tsrm_tls_get()                 NULL</div></pre></td></tr></table></figure>
<p>由此可见，tsrm_tls(Thread local storage)对象，实现的只是将普通变量，转换成TSD的处理!</p>
<h3 id="PHP中的相关的宏和函数"><a href="#PHP中的相关的宏和函数" class="headerlink" title="PHP中的相关的宏和函数"></a>PHP中的相关的宏和函数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">#define ZEND_TSRMLS_CACHE TSRMLS_CACHE</div><div class="line">#define TSRMLS_CACHE_UPDATE() TSRMLS_CACHE = tsrm_get_ls_cache()</div><div class="line">#define TSRMG_BULK_STATIC(id, type) ((type) (*((void ***) TSRMLS_CACHE))[TSRM_UNSHUFFLE_RSRC_ID(id)])</div><div class="line">#define TSRMG_STATIC(id, type, element)	  (TSRMG_BULK_STATIC(id, type)-&gt;element)</div><div class="line"> </div><div class="line">void *tsrm_get_ls_cache(void)</div><div class="line">&#123;</div><div class="line">    return tsrm_tls_get();</div><div class="line">&#125;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/06/07/朴素算法/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/07/朴素算法/" itemprop="url">
                  朴素算法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-07T23:00:39+08:00">
                2017-06-07
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="算法时间和空间复杂度"><a href="#算法时间和空间复杂度" class="headerlink" title="算法时间和空间复杂度"></a>算法时间和空间复杂度</h1><h3 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h3><table>
<thead>
<tr>
<th style="text-align:left">排序法</th>
<th style="text-align:right">时间复杂度</th>
<th style="text-align:right">最坏时间复杂度</th>
<th style="text-align:right">稳定度</th>
<th style="text-align:right">空间复杂度</th>
<th style="text-align:center">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">冒泡</td>
<td style="text-align:right">O(N2)</td>
<td style="text-align:right">O(N2)</td>
<td style="text-align:right">稳定</td>
<td style="text-align:right">O(1)</td>
<td style="text-align:center">n较小</td>
</tr>
<tr>
<td style="text-align:left">选择</td>
<td style="text-align:right">O(N2)</td>
<td style="text-align:right">O(N2)</td>
<td style="text-align:right">不稳定</td>
<td style="text-align:right">O(1)</td>
<td style="text-align:center">n较小</td>
</tr>
<tr>
<td style="text-align:left">插入</td>
<td style="text-align:right">O(N2)</td>
<td style="text-align:right">O(N2)</td>
<td style="text-align:right">不稳定</td>
<td style="text-align:right">O(1)</td>
<td style="text-align:center">n较小</td>
</tr>
<tr>
<td style="text-align:left">希尔</td>
<td style="text-align:right">O(NlgN)</td>
<td style="text-align:right">O(Ns)(1 &lt; s &lt;2)</td>
<td style="text-align:right">不稳定</td>
<td style="text-align:right">O(1)</td>
<td style="text-align:center">s是所选分组</td>
</tr>
<tr>
<td style="text-align:left">快速</td>
<td style="text-align:right">O(NlgN)</td>
<td style="text-align:right">O(N2)</td>
<td style="text-align:right">不稳定</td>
<td style="text-align:right">O(NlgN)</td>
<td style="text-align:center">n较大</td>
</tr>
<tr>
<td style="text-align:left">堆排序</td>
<td style="text-align:right">O(NlgN)</td>
<td style="text-align:right">O(NlgN)</td>
<td style="text-align:right">不稳定</td>
<td style="text-align:right">O(1)</td>
<td style="text-align:center">n较大</td>
</tr>
<tr>
<td style="text-align:left">归并排序</td>
<td style="text-align:right">O(NlgN)</td>
<td style="text-align:right">O(NlgN)</td>
<td style="text-align:right">稳定</td>
<td style="text-align:right">O(1)</td>
<td style="text-align:center">n较大</td>
</tr>
</tbody>
</table>
<hr>
<h1 id="递归"><a href="#递归" class="headerlink" title="递归"></a>递归</h1><h2 id="分治法"><a href="#分治法" class="headerlink" title="分治法"></a>分治法</h2><h3 id="最大值问题"><a href="#最大值问题" class="headerlink" title="最大值问题"></a>最大值问题</h3><h3 id="尺子上画刻度问题"><a href="#尺子上画刻度问题" class="headerlink" title="尺子上画刻度问题"></a>尺子上画刻度问题</h3><h2 id="动态规划"><a href="#动态规划" class="headerlink" title="动态规划"></a>动态规划</h2><h3 id="斐波纳契数"><a href="#斐波纳契数" class="headerlink" title="斐波纳契数"></a>斐波纳契数</h3><h3 id="背包问题"><a href="#背包问题" class="headerlink" title="背包问题"></a>背包问题</h3><h2 id="树"><a href="#树" class="headerlink" title="树"></a>树</h2><h3 id="树的遍历"><a href="#树的遍历" class="headerlink" title="树的遍历"></a>树的遍历</h3><h3 id="平衡树"><a href="#平衡树" class="headerlink" title="平衡树"></a>平衡树</h3><h3 id="B树"><a href="#B树" class="headerlink" title="B树"></a>B树</h3><h2 id="图"><a href="#图" class="headerlink" title="图"></a>图</h2><h3 id="图的遍历"><a href="#图的遍历" class="headerlink" title="图的遍历"></a>图的遍历</h3><h2 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h2><h3 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h3><h3 id="基数排序"><a href="#基数排序" class="headerlink" title="基数排序"></a>基数排序</h3><h2 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h2><h3 id="二分搜索"><a href="#二分搜索" class="headerlink" title="二分搜索"></a>二分搜索</h3><h3 id="基数搜索"><a href="#基数搜索" class="headerlink" title="基数搜索"></a>基数搜索</h3><hr>
<h1 id="符号表"><a href="#符号表" class="headerlink" title="符号表"></a>符号表</h1>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/05/20/redis的并发性和设计/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/20/redis的并发性和设计/" itemprop="url">
                  redis并发性与设计
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-20T21:19:21+08:00">
                2017-05-20
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>也许以前对并发性理解的不够深，也许对一些概念和设计的理解还不够好，这样往往会在写代码的过程中，会留下一个感觉不是bug的bug,让你狠抓头皮，不能想明白，到底发生了什么？所以在考虑问题和在设计过程中，需要注意一些比较成熟的理念，认识到你使用的产品和所写的业务是一种什么的业务，并发性和耗时在一定程度上有一定的关联，你可能想想不到这种关联在什么程度上影响着你的代码的执行，先看下以下的代码，抛开设计，只看代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">$redis = new redis();</div><div class="line">$redis-&gt;connect(&apos;127.0.0.1&apos;,6379);</div><div class="line"></div><div class="line">$key = &apos;users&apos;;</div><div class="line">$page = $argv[1];</div><div class="line">$offset = 10;</div><div class="line">$key = &apos;users&apos;;</div><div class="line">$result = $redis-&gt;zrange($key,($page-1) * $offset - 1, $offset);</div><div class="line"></div><div class="line">if(empty($result))&#123;</div><div class="line">    $redis-&gt;del($key);</div><div class="line">    $redis-&gt;expire($key,30);</div><div class="line"></div><div class="line">    $i = 0;</div><div class="line">    while($i &lt; 100)&#123;</div><div class="line">        $redis-&gt;zIncrBy($key,1,$i);</div><div class="line">        sleep(2);</div><div class="line">        $i++;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>代码很简单，就是如果缓存为空，就重新写缓存，也许你并没有发现这段代码到底存在什么问题，那么就看看下面的问题，先执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; zrange users 0 -1 withscores</div><div class="line"> 1) &quot;0&quot;</div><div class="line"> 2) &quot;1&quot;</div><div class="line"> 3) &quot;1&quot;</div><div class="line"> 4) &quot;1&quot;</div><div class="line"> 5) &quot;2&quot;</div><div class="line"> 6) &quot;1&quot;</div><div class="line"> 7) &quot;3&quot;</div><div class="line"> 8) &quot;1&quot;</div><div class="line"> 9) &quot;4&quot;</div><div class="line">10) &quot;1&quot;</div></pre></td></tr></table></figure></p>
<p>哇，进去了呢，然后再来一次<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; zrange users 0 -1 withscores</div><div class="line"> 1) &quot;0&quot;</div><div class="line"> 2) &quot;1&quot;</div><div class="line"> 3) &quot;1&quot;</div><div class="line"> 4) &quot;1&quot;</div><div class="line"> 5) &quot;2&quot;</div><div class="line"> 6) &quot;1&quot;</div><div class="line"> 7) &quot;3&quot;</div><div class="line"> 8) &quot;1&quot;</div><div class="line"> 9) &quot;4&quot;</div><div class="line">10) &quot;1&quot;</div></pre></td></tr></table></figure></p>
<p>哇，还是进去了呢，不经喊了句，太完美了，暗暗自喜！难道真没问题了么？然后开启两个进程，看看发生了什么了吧，请看下面的执行结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">127.0.0.1:6379&gt; zrange users 0 -1 withscores</div><div class="line"> 1) &quot;0&quot;</div><div class="line"> 2) &quot;1&quot;</div><div class="line"> 3) &quot;1&quot;</div><div class="line"> 4) &quot;1&quot;</div><div class="line"> 5) &quot;2&quot;</div><div class="line"> 6) &quot;2&quot;</div><div class="line"> 7) &quot;3&quot;</div><div class="line"> 8) &quot;2&quot;</div><div class="line"> 9) &quot;4&quot;</div><div class="line">10) &quot;2&quot;</div></pre></td></tr></table></figure></p>
<p>糟糕，怎么会这样呢？这时候，你可能在问，靠，不会吧？但是事实就是这样，你的程序出现bug了，如果一个在线上运行的代码，你很有可能不知道怎么发生的，然后盯着你的代码在看，这怎么回事呢？没有日志可看，这时候，你傻眼了吧！这就是并发问题，这到底是怎么发生的呢？你删除了key,但是后面一直在运行了，还等不急运行完，然后有一个请求来了，正是这样耗时的操作，导致了你的设计跟你的想法背道而驰，话说回来了，这样的设计是一种比较糟糕的设计，把耗时的操作分离出来才是一种最佳实践，所以，别懒了，读写分离吧，一方面可以加快接口的速度，另一方面，当数据量比较大的时候，你就玩完了，还有就是避免这还种并发性问题，所以，别懒了，做好你的设计吧！想明白自己在做什么！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/05/08/图片与CDN/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/08/图片与CDN/" itemprop="url">
                  图片与CDN
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-08T20:50:52+08:00">
                2017-05-08
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>工作小记，关于图片，免不了使用CDN加速，但是那么多的图片，在处理的时候，如何处理失效是一个问题，因此在设计图片失效的问题上，一般处理方式是当图片更新之后，追加时间戳，但是这种方式存在的一个问题，谁来加这个时间戳，如何来存储时间戳，我们使用的方案是，当图片发生更新，就记录一个时间戳，并写入缓存，然后读取图片时候，看当前的图片是否存在时间戳，如果存在，则追加时间戳，如果不存在，则保持不变，的确这样是可以做到图片的实时更新，但是这样涉及到大量的存储，特别是当图片很多的时候。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/05/03/关于代码review/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/05/03/关于代码review/" itemprop="url">
                  关于code review
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-03T23:54:43+08:00">
                2017-05-03
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>什么样的代码才是好的代码？代码review需要注意哪些细节？</p>
<p>1.代码规范，每个公司都有自己的一个代码规范，比如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">1) 命名规范？</div><div class="line">2) 换行还是空行？</div><div class="line">3) Tab还是空格？</div><div class="line">4) 等号括号两边是否使用空格？</div><div class="line">5) 注释合理？</div><div class="line">6) 功能结构单一，函数和类不能太长，要具有模块性，单一职责？</div><div class="line">7) 单元测试，测试用例覆盖是否全面？</div><div class="line">8) git使用是否规范？</div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>2.CodeReview-checklist，每个团队或者个人都应该建立自己的checklist，在每次提交代码之前，都过一遍，比如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1) 什么写法可能导致性能低下？</div><div class="line">2) 哪个接口或者函数要慎用？</div><div class="line">3) 哪些设计方式需要规避？</div><div class="line">3) 什么习惯容易引发内存泄漏？</div><div class="line">.....</div></pre></td></tr></table></figure></p>
<p>3.影响范围评估<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1) 配置修改？各个环境是否兼容？</div><div class="line">2) 全局变量和全局函数修改？</div><div class="line">3) 是否存在数据安全和一致性问题？</div><div class="line">4) 容量评估？处理能力评估？是否会引起阻塞？</div><div class="line">5) 梳理业务，此修改是否全面，是否修改了所有相关的业务，还是只是修改了一部分？</div><div class="line">......</div></pre></td></tr></table></figure></p>
<p>4.design review<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1) 实现是否符合预期设计？</div><div class="line">2) 是否需要压测？</div><div class="line">3) 独立部署还是分开部署？是否需要进行容量评估？</div><div class="line">4）是否需要部署任务脚本？</div><div class="line">5) 是否需要申请独立域名？</div><div class="line">.....</div></pre></td></tr></table></figure></p>
<p>5.性能评估<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1) 关注for循环，关注批量处理，能合就合，能简就简，不能将就</div><div class="line">2) 关注索引，是否使用了索引</div><div class="line">3) 评估业务模型，是cpu密集型还是io密集型，简化设计，做好测试</div><div class="line">.....</div></pre></td></tr></table></figure></p>
<p>6.review级别<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">1）可编译</div><div class="line">2）可运行</div><div class="line">3）可测试</div><div class="line">4）可读</div><div class="line">5）可维护</div><div class="line">6）可重用</div><div class="line">7）可扩展</div></pre></td></tr></table></figure></p>
<p>7.review工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">1) Phabricator</div><div class="line">2) Gerrit</div><div class="line">3) Gitlab</div></pre></td></tr></table></figure></p>
<p>8.需求review<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1) 分析需求</div><div class="line">2) 需求是否合理</div><div class="line">3) 需求是否紧急</div><div class="line">4) 大需求？小需求？</div><div class="line">5) 拒绝和简化需求</div></pre></td></tr></table></figure></p>
<p>代码review是一个关注自己成长和产品质量的一个问题，每个程序员都应该引起重视，把不好的习惯扼杀掉，减少了bug，同时也能得到同事的认可，也能让自己给别人找找茬，不要让自己累成牲口，停下来想想，问一下自己，自己成为牲口的原因，是不是就是因为自己做事时候像就牲口一样思考？</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/04/04/并发编程Promise,Future和Callback/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/04/并发编程Promise,Future和Callback/" itemprop="url">
                  并发编程 Promise, Future 和 Callback
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-04T14:13:42+08:00">
                2017-04-04
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Futures and Promises</p>
<p>By: Philipp Haller, Aleksandar Prokopec, Heather Miller, Viktor Klang, Roland Kuhn, and Vojin Jovanovic</p>
<p>This SIP is part of two SIPs, which together constitute a redesign of scala.concurrent into a unified substrate for a variety of parallel frameworks. This proposal focuses on futures and promises.</p>
<p>Introduction<br>Futures provide a nice way to reason about performing many operations in parallel– in an efficient and non-blocking way. The idea is simple, a Future is a sort of placeholder object that you can create for a result that doesn’t yet exist. Generally, the result of the Future is computed concurrently and can be later collected. Composing concurrent tasks in this way tends to result in faster, asynchronous, non-blocking parallel code.</p>
<p>This is particularly evident due to the fact that within the Scala ecosystem alone, several frameworks aiming to provide a full-featured implementation of futures and promises have arisen, including the futures available in the Scala Actors package [4], Akka [3], Finagle [2], and Scalaz [5].</p>
<p>The redesign of scala.concurrent provides a new Futures and Promises API, meant to act as a common foundation for multiple parallel frameworks and libraries to utilize both within Scala’s standard library, and externally.</p>
<p>By default, futures and promises are non-blocking, making use of callbacks instead of typical blocking operations. In an effort to facilitate, and make use of callbacks on a higher-level, we provide combinators such as flatMap, foreach, and filter for composing futures in a non-blocking way. For cases where blocking is absolutely necessary, futures can be blocked on (although it is discouraged).</p>
<p>The futures and promises API builds upon the notion of an ExecutionContext, an execution environment designed to manage resources such as thread pools between parallel frameworks and libraries (detailed in an accompanying SIP, forthcoming). Futures and promises are created through such ExecutionContexts. For example, this makes it possible, in the case of an application which requires blocking futures, for an underlying execution environment to resize itself if necessary to guarantee progress.</p>
<p>Futures<br>A future is an abstraction which represents a value which may become available at some point. A Future object either holds a result of a computation or an exception in the case that the computation failed. An important property of a future is that it is in effect immutable– it can never be written to or failed by the holder of the Future object.</p>
<p>The simplest way to create a future object is to invoke the future method which starts an asynchronous computation and returns a future holding the result of that computation. The result becomes available once the future completes.</p>
<p>Here is an example. Let’s assume that we want to use the API of some popular social network to obtain a list of friends for a given user. After opening a new session we want to create an asynchronous request to the server for this list:</p>
<p>import scala.concurrent.Future<br>val session = socialNetwork.createSessionFor(“user”, credentials)<br>val f: Future[List[Friend]] = Future {<br>  session.getFriends<br>}<br>The list of friends becomes available in the future f once the server responds.</p>
<p>An unsuccessful attempt may result in an exception. In the following example, the session value is incorrectly initialized, so the future will hold a NullPointerException instead of the value:</p>
<p>val session = null<br>val f: Future[List[Friend]] = Future {<br>  session.getFriends<br>}<br>Callbacks<br>We are generally interested in the result value of the computation. To obtain the future’s result, a client of the future would have to block until the future is completed. Although this is allowed by the Future API as we will show later in this document, a better way to do it is in a completely non-blocking way, by registering a callback on the future. This callback is called asynchronously once the future is completed. If the future has already been completed when registering the callback, then the callback may either be executed asynchronously, or sequentially on the same thread.</p>
<p>The most general form of registering a callback is by using the onComplete method, which takes a callback function of type Either[Throwable, T] =&gt; U. The callback is applied to the value of type Right[T] if the future completes successfully, or to a value of type Left[Throwable] otherwise. The onComplete method is parametric in the return type of the callback, but it discards the result of the callback.</p>
<p>Coming back to our social network example, let’s assume we want to fetch a list of our own recent posts and render them to the screen. We do so by calling the method getRecentPosts which returns a List[String]:</p>
<p>val f: Future[List[String]] = Future {<br>  session.getRecentPosts<br>}<br>f onComplete {<br>  case Right(posts) =&gt; for (post &lt;- posts) render(post)<br>  case Left(t)  =&gt; render(“An error has occured: “ + t.getMessage)<br>}<br>The onComplete method is general in the sense that it allows the client to handle the result of both failed and successful future computations. To handle only successful results, the onSuccess callback is used (which takes a partial function):</p>
<p>val f: Future[List[String]] = Future {<br>  session.getRecentPosts<br>}<br>f onSuccess {<br>  case posts =&gt; for (post &lt;- posts) render(post)<br>}<br>To handle failed results, the onFailure callback is used:</p>
<p>val f: Future[List[String]] = Future {<br>  session.getRecentPosts<br>}<br>f onFailure {<br>  case t =&gt; render(“An error has occured: “ + t.getMessage)<br>}<br>f onSuccess {<br>  case posts =&gt; for (post &lt;- posts) render(post)<br>}<br>The onFailure callback is only executed if the future fails, that is, if it contains an exception. The onComplete, onSuccess, and onFailure methods have result type Unit, which means invocations of these methods cannot be chained. This is an intentional design decision which was made to avoid suggesting that chained invocations may imply an ordering on the execution of the registered callbacks (callbacks registered on the same future are unordered).</p>
<p>Since partial functions have the isDefinedAt method, the onFailure method only triggers the callback if it is defined for a particular Throwable. In the following example the registered callback is never triggered:</p>
<p>val f = Future {<br>  2 / 0<br>}<br>f onFailure {<br>  case npe: NullPointerException =&gt;<br>    println(“I’d be amazed if this printed out.”)<br>}<br>Having a regular function callback as an argument to onFailure would require including the default case in every failure callback, which is cumbersome– omitting the default case would lead to MatchErrors later.</p>
<p>Second, try-catch blocks also expect a PartialFunction value. That means that if there are generic partial function exception handlers present in the application then they will be compatible with the onFailure method.</p>
<p>In conclusion, the semantics of callbacks are as follows:</p>
<p>Registering an onComplete callback on the future ensures that the corresponding closure is invoked after the future is completed, eventually.</p>
<p>Registering an onSuccess or onFailure callback has the same semantics as onComplete, with the difference that the closure is only called if the future is completed successfully or fails, respectively.</p>
<p>Registering a callback on the future which is already completed will result in the callback being executed eventually (as implied by 1). Furthermore, the callback may even be executed synchronously on the same thread that registered the callback if this does not cancel progress of that thread.</p>
<p>In the event that multiple callbacks are registered on the future, the order in which they are executed is not defined. In fact, the callbacks may be executed concurrently with one another. However, a particular Future implementation may have a well-defined order.</p>
<p>In the event that some of the callbacks throw an exception, the other callbacks are executed regardlessly.</p>
<p>In the event that some of the callbacks never complete (e.g. the callback contains an infinite loop), the other callbacks may not be executed at all. In these cases, a potentially blocking callback must use the blocking construct (see below).</p>
<p>Once executed, the callbacks are removed from the future object, thus being eligible for GC.</p>
<p>Functional Composition and For-Comprehensions<br>The examples we have shown so far lend themselves naturally to the functional composition of futures. Assume we have an API for interfacing with a currency trading service. Suppose we want to buy US dollars, but only when it’s profitable. We first show how this could be done using callbacks:</p>
<p>val rateQuote = Future {<br>  connection.getCurrentValue(USD)<br>}<br>rateQuote onSuccess { case quote =&gt;<br>  val purchase = Future {<br>    if (isProfitable(quote)) connection.buy(amount, quote)<br>    else throw new Exception(“not profitable”)<br>  }</p>
<p>  purchase onSuccess {<br>    case _ =&gt; println(“Purchased “ + amount + “ USD”)<br>  }<br>}<br>We start by creating a future which fetches the current exchange rate. After it’s successfully obtained from the server, we create another future which makes a decision to buy only if it’s profitable to do so, and then sends a requests.</p>
<p>This works, but is inconvenient for two reasons. First, we have to use onSuccess, and we have to nest the second purchase future within it. Second, the purchase future is not in the scope of the rest of the code.</p>
<p>For these two reasons, futures provide combinators which allow a more straightforward composition. One of the basic combinators is map, which, given a future and a mapping function for the value of the future, produces a new future that is completed with the mapped value once the original future is successfully completed. Let’s rewrite the previous example using the map combinator:</p>
<p>val rateQuote = Future {<br>  connection.getCurrentValue(USD)<br>}<br>val purchase = rateQuote map {<br>  quote =&gt; if (isProfitable(quote)) connection.buy(amount, quote)<br>           else throw new Exception(“not profitable”)<br>}<br>purchase onSuccess {<br>  case _ =&gt; println(“Purchased “ + amount + “ USD”)<br>}<br>The semantics of map is as follows. If the original future is completed successfully then the returned future is completed with a mapped value from the original future. If the mapping function throws an exception the future is completed with that exception. If the original future fails with an exception then the returned future also contains the same exception. This exception propagating semantics is present in the rest of the combinators, as well.</p>
<p>To enable for-comprehensions, futures also have the flatMap, filter and foreach combinators. The flatMap method takes a function that maps the value to a new future g, and then returns a future which is completed once g is completed.</p>
<p>Lets assume that we want to exchange US dollars for Swiss francs (CHF). We have to fetch quotes for both currencies, and then decide on buying based on both quotes. Here is an example of flatMap usage within for-comprehensions:</p>
<p>val usdQuote = Future { connection.getCurrentValue(USD) }<br>val chfQuote = Future { connection.getCurrentValue(CHF) }<br>val purchase = for {<br>  usd &lt;- usdQuote<br>  chf &lt;- chfQuote<br>  if isProfitable(usd, chf)<br>} yield connection.buy(amount, chf)<br>purchase onSuccess {<br>  case _ =&gt; println(“Purchased “ + amount + “ CHF”)<br>}<br>The filter combinator creates a new future which contains the value of the original future only if it satisfies some predicate. Otherwise, the new future is failed with a NoSuchElementException.</p>
<p>It is important to note that calling the foreach combinator does not block. Instead, the function for the foreach gets asynchronously executed only if the future is completed successfully. This means that the foreach has exactly the same semantics as the onSuccess callback.</p>
<p>Since the Future trait can conceptually contain two types of values (computation results and exceptions), there exists a need for combinators which handle exceptions.</p>
<p>Let’s assume that based on the rateQuote we decide to buy a certain amount. The connection.buy method takes an amount to buy and the expected quote. It returns the amount bought. If the quote has changed in the meanwhile, it will throw a QuoteChangedException and it will not buy anything. If we want our future to contain 0 instead of the exception, we use the recover combinator:</p>
<p>val purchase: Future[Int] = rateQuote map {<br>  quote =&gt; connection.buy(amount, quote)<br>} recover {<br>  case quoteExc: QuoteChangedException =&gt; 0<br>}<br>The recover combinator creates a new future which holds the same result as the original future if it completed successfully. If it did not then the partial function argument is applied to the Throwable which failed the original future. If it maps the Throwable to some value, then the new future is successfully completed with that value.</p>
<p>The recoverWith combinator creates a new future which holds the same result as the original future if it completed successfully. Otherwise, the partial function is applied to the Throwable which failed the original future. If it maps the Throwable to some future, then this future is completed with the result of that future. Its relation to recover is similar to that of flatMap to map.</p>
<p>Combinator fallbackTo creates a new future which holds the result of this future if it was completed successfully, or otherwise the successful result of the argument future. In the event that both this future and the argument future fail, the new future is completed with the exception from this future, as in the following example which tries to print US dollar value, but prints the Swiss franc value in the case it fails to obtain the dollar value:</p>
<p>val usdQuote = Future {<br>  connection.getCurrentValue(USD)<br>} map {<br>  usd =&gt; “Value: “ + usd + “$”<br>}<br>val chfQuote = Future {<br>  connection.getCurrentValue(CHF)<br>} map {<br>  chf =&gt; “Value: “ + chf + “CHF”<br>}<br>val anyQuote = usdQuote fallbackTo chfQuote<br>anyQuote onSuccess { println(_) }<br>The either combinator creates a new future which either holds the result of this future or the argument future, whichever completes first, irregardless of success or failure. Here is an example in which the quote which is returned first gets printed:</p>
<p>val usdQuote = Future {<br>  connection.getCurrentValue(USD)<br>} map {<br>  usd =&gt; “Value: “ + usd + “$”<br>}<br>val chfQuote = Future {<br>  connection.getCurrentValue(CHF)<br>} map {<br>  chf =&gt; “Value: “ + chf + “CHF”<br>}<br>val anyQuote = usdQuote either chfQuote<br>anyQuote onSuccess { println(_) }<br>The andThen combinator is used purely for side-effecting purposes. It returns a new future with exactly the same result as the current future, irregardless of whether the current future failed or not. Once the current future is completed with the result, the closure corresponding to the andThen is invoked and then the new future is completed with the same result as this future. This ensures that multiple andThen calls are ordered, as in the following example which stores the recent posts from a social network to a mutable set and then renders all the posts to the screen:</p>
<p>val allposts = mutable.Set<a href="">String</a><br>Future {<br>  session.getRecentPosts<br>} andThen {<br>  case Success(posts) =&gt; allposts ++= posts<br>} andThen {<br>  case _ =&gt;<br>  clearAll()<br>  for (post &lt;- allposts) render(post)<br>}<br>In summary, the combinators on futures are purely functional. Every combinator returns a new future which is related to the future it was derived from.</p>
<p>Projections<br>To enable for-comprehensions on a result returned as an exception, futures also have projections. If the original future fails, the failed projection returns a future containing a value of type Throwable. If the original future succeeds, the failed projection fails with a NoSuchElementException. The following is an example which prints the exception to the screen:</p>
<p>val f = Future {<br>  2 / 0<br>}<br>for (exc &lt;- f.failed) println(exc)<br>The following example does not print anything to the screen:</p>
<p>val f = Future {<br>  4 / 2<br>}<br>for (exc &lt;- f.failed) println(exc)<br>Extending Futures<br>Support for extending the Futures API with additional utility methods is planned. This will allow external frameworks to provide more specialized utilities.</p>
<p>Blocking<br>As mentioned earlier, blocking on a future is strongly discouraged – for the sake of performance and for the prevention of deadlocks – in favour of using callbacks and combinators on futures. However, blocking may be necessary in certain situations and is supported by the Futures API.</p>
<p>In the currency trading example above, one place to block is at the end of the application to make sure that all of the futures have been completed. Here is an example of how to block on the result of a future:</p>
<p>import scala.concurrent._<br>def main(args: Array[String]) {<br>  val rateQuote = Future {<br>    connection.getCurrentValue(USD)<br>  }</p>
<p>  val purchase = rateQuote map {<br>    quote =&gt; if (isProfitable(quote)) connection.buy(amount, quote)<br>             else throw new Exception(“not profitable”)<br>  }</p>
<p>  blocking(purchase, 0 ns)<br>}<br>In the case that the future fails, the caller is forwarded the exception that the future is failed with. This includes the failed projection– blocking on it results in a NoSuchElementException being thrown if the original future is completed successfully.</p>
<p>The Future trait implements the Awaitable trait with a single method await(). The await() method contains code which can potentially result in a long running computation, block on some external condition or which may not complete the computation at all. The await() method cannot be called directly by the clients, it can only be called by the execution context implementation itself. To block on the future to obtain its result, the blocking method must be used.</p>
<p>val f = Future { 1 }<br>val one: Int = blocking(f, 0 ns)<br>To allow clients to call 3rd party code which is potentially blocking and avoid implementing the Awaitable trait, the same blocking primitive can also be used in the following form:</p>
<p>blocking {<br>  potentiallyBlockingCall()<br>}<br>The blocking code may also throw an exception. In this case, the exception is forwarded to the caller.</p>
<p>Exceptions<br>When asynchronous computations throw unhandled exceptions, futures associated with those computations fail. Failed futures store an instance of Throwable instead of the result value. Futures provide the onFailure callback method, which accepts a PartialFunction to be applied to a Throwable. The following special exceptions are treated differently:</p>
<p>TimeoutException - stored when the computation is not completed before some timeout (typically managed by an external scheduler).<br>scala.runtime.NonLocalReturnControl[_] - this exception holds a value associated with the return. Typically, return constructs in method bodies are translated to throws with this exception. Instead of keeping this exception, the associated value is stored into the future or a promise.</p>
<p>ExecutionException - stored when the computation fails due to an unhandled InterruptedException, Error or a scala.util.control.ControlThrowable. In this case the ExecutionException has the unhandled exception as its cause. These exceptions are rethrown in the thread executing the failed asynchronous computation. The rationale behind this is to prevent propagation of critical and control-flow related exceptions normally not handled by the client code and at the same time inform the client in which future the computation failed.</p>
<p>Promises<br>While futures are defined as a type of read-only placeholder object created for a result which doesn’t yet exist, a promise can be thought of as a writeable, single-assignment container, which completes a future. That is, a promise can be used to successfully complete a future with a value (by “completing” the promise) using the success method. Conversely, a promise can also be used to complete a future with an exception, by failing the promise, using the failure method.</p>
<p>A promise p completes the future returned by p.future. This future is specific to the promise p. Depending on the implementation, it may be the case that p.future == p.</p>
<p>Consider the following producer-consumer example:</p>
<p>import scala.concurrent.{ Future, Promise }<br>val p = Promise<a href="">T</a><br>val f = p.future<br>val producer = Future {<br>  val r = produceSomething()<br>  p success r<br>  continueDoingSomethingUnrelated()<br>}<br>val consumer = Future {<br>  startDoingSomething()<br>  f onSuccess {<br>    case r =&gt; doSomethingWithResult()<br>  }<br>}<br>Here, we create a promise and use its future method to obtain the Future that it completes. Then, we begin two asynchronous computations. The first does some computation, resulting in a value r, which is then used to complete the future f, by fulfilling p. The second does some computation, and then reads the result r of the completed future f. Note that the consumer can obtain the result before the producer task is finished executing the continueDoingSomethingUnrelated() method.</p>
<p>As mentioned before, promises have single-assignment semantics. As such, they can be completed only once. Calling success on a promise that has already been completed (or failed) will throw an IllegalStateException.</p>
<p>The following example shows how to fail a promise.</p>
<p>val p = Promise<a href="">T</a><br>val f = p.future<br>val producer = Future {<br>  val r = someComputation<br>  if (isInvalid(r))<br>    p failure (new IllegalStateException)<br>  else {<br>    val q = doSomeMoreComputation(r)<br>    p success q<br>  }<br>}<br>Here, the producer computes an intermediate result r, and checks whether it’s valid. In the case that it’s invalid, it fails the promise by completing the promise p with an exception. In this case, the associated future f is failed. Otherwise, the producer continues its computation, and finally completes the future f with a valid result, by completing promise p.</p>
<p>Promises can also be completed with a complete method which takes either a failed result of type Left[Throwable] or a successful result of type Right[T].</p>
<p>Analogous to success, calling failure and complete on a promise that has already been completed will throw an IllegalStateException.</p>
<p>One nice property of programs written using promises with operations described so far and futures which are composed through monadic operations without side-effects is that these programs are deterministic. Deterministic here means that, given that no exception is thrown in the program, the result of the program (values observed in the futures) will always be the same, irregardless of the execution schedule of the parallel program.</p>
<p>In some cases the client may want to complete the promise only if it has not been completed yet (e.g., there are several HTTP requests being executed from several different futures and the client is interested only in the first HTTP response - corresponding to the first future to complete the promise). For these reasons methods tryComplete, trySuccess and tryFailure exist on future. The client should be aware that using these methods results in programs which are not deterministic, but depend on the execution schedule.</p>
<p>The method completeWith completes the promise with another future. After the future is completed, the promise gets completed with the result of that future as well. The following program prints 1:</p>
<p>val f = Future { 1 }<br>val p = Promise<a href="">Int</a><br>p completeWith f<br>p.future onSuccess {<br>  case x =&gt; println(x)<br>}<br>When failing a promise with an exception, three subtypes of Throwables are handled specially. If the Throwable used to break the promise is a scala.runtime.NonLocalReturnControl, then the promise is completed with the corresponding value. If the Throwable used to break the promise is an instance of Error, InterruptedException, or scala.util.control.ControlThrowable, the Throwable is wrapped as the cause of a new ExecutionException which, in turn, is failing the promise.</p>
<p>Utilities<br>To simplify handling of time in concurrent applications scala.concurrent will introduce a Duration abstraction. Duration is not supposed be yet another general time abstraction. It is meant to be used with concurrency libraries and will reside in scala.concurrent.util package.</p>
<p>Duration is the base class representing length of time. It can be either finite or infinite. Finite duration is represented with FiniteDuration class which is constructed from Long length and java.util.concurrent.TimeUnit. Infinite durations, also extended from Duration, exist in only two instances , Duration.Inf and Duration.MinusInf. Library also provides several Duration subclasses for implicit conversion purposes and those should not be used.</p>
<p>Abstract Duration contains methods that allow :</p>
<p>Conversion to different time units (toNanos, toMicros, toMillis, toSeconds, toMinutes, toHours, toDays and toUnit(unit: TimeUnit)).<br>Comparison of durations (&lt;, &lt;=, &gt; and &gt;=).<br>Arithmetic operations (+, -, *, / and unary<em>-).<br>Minimum and maximum between this duration and the one supplied in the argument (min, max).<br>Check if the duration is finite (finite</em>?).<br>Duration can be instantiated in the following ways:</p>
<p>Implicitly from types Int and Long. For example val d = 100 millis.<br>By passing a Long length and a java.util.concurrent.TimeUnit. For example val d = Duration(100, MILLISECONDS).<br>By parsing a string that represent a time period. For example val d = Duration(“1.2 µs”).<br>Duration also provides unapply methods so it can be used in pattern matching constructs. Examples:</p>
<p>import scala.concurrent.util.Duration<br>import scala.concurrent.util.duration.<em><br>import java.util.concurrent.TimeUnit.</em></p>
<p>// instantiation<br>val d1 = Duration(100, MILLISECONDS) // from Long and TimeUnit<br>val d2 = Duration(100, “millis”) // from Long and String<br>val d3 = 100 millis // implicitly from Long, Int or Double<br>val d4 = Duration(“1.2 µs”) // from String<br>// pattern matching<br>val Duration(length, unit) = 5 millis<br>References<br>The Task-Based Asynchronous Pattern, Stephen Toub, Microsoft, April 2011<br>Finagle Documentation<br>Akka Documentation: Futures<br>Scala Actors Futures<br>Scalaz Futures</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Kivmi" />
          <p class="site-author-name" itemprop="name">Kivmi</p>
          <p class="site-description motion-element" itemprop="description">代码也是有灵魂的</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">28</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kivmi</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  

  


</body>
</html>
