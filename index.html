<!doctype html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="代码也是有灵魂的">
<meta property="og:type" content="website">
<meta property="og:title" content="Learn And Life.">
<meta property="og:url" content="http://chanlan.github.io/index.html">
<meta property="og:site_name" content="Learn And Life.">
<meta property="og:description" content="代码也是有灵魂的">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Learn And Life.">
<meta name="twitter:description" content="代码也是有灵魂的">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://chanlan.github.io/"/>





  <title> Learn And Life. </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Learn And Life.</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Focus on php and open source.</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/04/04/清明节祭/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/04/清明节祭/" itemprop="url">
                  清明节祭
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-04T12:25:50+08:00">
                2017-04-04
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">我爸爸走了，走的那么快，就在我前年回京不久的后三天，我都来不及孝顺他，他就走了，我还记得我临走的时候，我爸爸在我二哥家的新房子里，正在用毛巾擦拭房子装修后留下来的污垢，他冲我笑了笑，然后说，“你走了”，我说，”嗯“，我跟他总是很少有言语，然后我坐上班车，头也不回的走了，看着渐行渐远的村子，慢慢的在我眼前消失。每次国庆我都会回去，我爸妈种了几亩田地，一到国庆，正是农忙时节，我会回去帮我爸妈收稻子，虽然我力气不大，但是能帮的就帮 ，家里条件不好，没有车，爸妈只能使蛮力拉着班车干农活，我一直在想跟我爸买一辆三轮车，但是终究还是没有买，因为我不想他们还这样忙碌下去，都忙碌了一辈子，为了我们几个还在，操碎了心，我爸头发都白了，有时候都不忍心正眼看他，想想我还很小的时候，我爸伏在案头，记着账本，后来眼睛视力下降，戴着老花镜伏在案头记账本，那时候，我觉得我爸在我心中，是一个书生，但是终究是一个文弱书生，只能凭借自己仅有的力气，卖力干活，我不想他那么辛苦，但是终究他还是那么辛苦，即使是在走的那一天，他还是那么辛苦，我常常觉得我爸还活着，从没有离开，只是有时候想他了，拿起电话，看着他的号码，我才想起我爸走了，真的走了，我才失声痛哭，我还没来得及好好的看看他老人家，我还没来得及好好孝顺他老人家，我还没来得及带他来北京逛逛，我还没来得及陪他终老，带他看看这个世界，看看自己曾经去过没有去过的地方，在我爸的心里，他只想我，我能幸福就够了，他也许没想过他会去什么地方，他也许没想过，在他儿子的心里幸福是什么样子，我爸从来没有花我一分钱，还在为我攒钱，为这个家攒钱，他有三个儿子，我告诉他，我们几个养你就好，可是他还是终究日夜操劳，凌晨守班，爸爸吃完晚饭，就骑着摩托车到他单位去了，有时候睡在那里吃在那里，吃饭很简陋，我听我妈说，早上就煮碗清汤面就上班去了，那是什么样的日子呀！在单位吃饭，也没有买好点的菜，将就着吃，有时候想想我爸，我都很难以下咽，我爸从来没有吃过，都没有看过，生活如此，作为儿子的我是多么的痛心，往事不堪回首，我不知道他们是多么艰难的熬过来，他们倾其所有，把他们最最的爱给了他们的儿子，孙子，而牺牲了自己，多么的可悲，多么的愚蠢！爸，我真的不希望那么做，其实这个家并没有那么穷，只是你太爱你的儿子，媳妇，孙子，孙女了！我还没有结婚，也是我爸妈最担心的事，我一直拖着，不是不想，是因为房子太贵，我没有那么多的积蓄，靠自己买一套房子，工作五年，那有那么多钱买房子呢？想想爸爸为了我戒烟，那时候我还在上学，学费比较贵，我学费是我爸，我叔，我哥他们出的，虽然我爸赚的钱不多，但是为了我还是那么的辛苦，当时也没有那么心疼他，但是现在想来，他为我牺牲的太多！爸，我真的希望你还活着，健康的活着，我不想你再去赚钱，这个家对你来说，真的不是钱能解决的问题，我只想这个家是幸福的，快乐的，有钱花就够了，我不想牺牲你来换来那几个钱，不值得，爸，你在地下，儿子在地上，阴阳相隔，我希望你你能在那边开开心心，再也不要为了这个家，操碎心，你活着的时候从来没花我一分钱，儿子不孝，只能给你烧些纸钱，希望你能收到，爸，有时候想想什么时候能跟你一起吃饭喝酒，有说有笑，那是多么开心的事，简单而幸福，可是再也不能了！</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/04/04/hello-world/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/04/hello-world/" itemprop="url">
                  RD or TDD ...
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-04-04T12:16:56+08:00">
                2017-04-04
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近从做视频源站服务，开始转向做前端业务需求，也熟悉了下前端业务的代码以及基本的架构，因为最近需求少，来了之后基本没活，不经产生一种疑问？难不成我就这样一直等着？</p>
<p>开始在想，要不把code reviwe做好？优化下整体架构？对机器人模块进行重构？还是站在整个产品的角度审思下现有的架构设计和业务架构设计，然后对现有的业务进行重新的梳理？但是目前，线上业务是正常的，有必要这么做么？<br>于是产生了，是否做完RD， 就应该开始做TDD？</p>
<p>没有一个规范的开发流程和开发思路，TDD也是敏捷开发中比较适用的一种方式，其基本的目标就是：<br>    1.确保所有的需求都能被照顾到<br>    2.在代码不断增加和重构的过程中，可以检查所有的功能是否正确<br>所以，也觉得是可以做的，也能彼此对自己的业务更加的熟悉，但是TDD有几个比较难以处理的问题就是：<br>    1.测试范围的确定<br>    2.关注测试而不是设计<br>    3.TDD导致大量的Mock和Stub<br>    4.Test Case并没有想像中的那么简单</p>
<p>送给一直在奋斗的亲们，也希望大家跟我交流。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2017/01/06/迭代器一二/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/01/06/迭代器一二/" itemprop="url">
                  迭代器一二
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-06T13:00:39+08:00">
                2017-01-06
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>php当中有许多迭代器，但是日常的编程当中可能会很少使用，一方面是因为迭代的功能有限，只能在有限的对象集中使用，另一方面还是面向对象的思想的匮乏，下面看看php当中的一些迭代器</p>
<p>迭代器接口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">interface Iterator &#123;</div><div class="line">    function rewind();</div><div class="line">    function current();</div><div class="line">    function key();</div><div class="line">    function next();</div><div class="line">    function valid();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>php中的迭代器的应用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">ArrayIterator implements ArrayAccess , SeekableIterator , Countable , Serializable</div><div class="line">AppendIterator extends IteratorIterator implements OuterIterator</div><div class="line">CachingIterator extends IteratorIterator implements OuterIterator , ArrayAccess , Countable </div><div class="line">CallbackFilterIterator extends FilterIterator implements OuterIterator</div><div class="line">DirectoryIterator extends SplFileInfo implements SeekableIterator</div><div class="line">EmptyIterator implements Iterator</div><div class="line">FilesystemIterator extends DirectoryIterator implements SeekableIterator</div><div class="line">abstract FilterIterator extends IteratorIterator implements OuterIterator</div><div class="line">GlobIterator extends FilesystemIterator implements SeekableIterator , Countable</div><div class="line">InfiniteIterator extends IteratorIterator implements OuterIterator</div><div class="line">IteratorIterator implements OuterIterator</div><div class="line">LimitIterator extends IteratorIterator implements OuterIterator</div><div class="line">MultipleIterator implements Iterator</div><div class="line">NoRewindIterator extends IteratorIterator </div><div class="line">ParentIterator extends RecursiveFilterIterator implements RecursiveIterator , OuterIterator</div><div class="line">RecursiveArrayIterator extends ArrayIterator implements RecursiveIterator </div><div class="line">RecursiveCachingIterator extends CachingIterator implements Countable , ArrayAccess , OuterIterator , RecursiveIterator</div><div class="line">RecursiveCallbackFilterIterator extends CallbackFilterIterator implements OuterIterator , RecursiveIterator</div><div class="line">RecursiveDirectoryIterator extends FilesystemIterator implements SeekableIterator , RecursiveIterator</div><div class="line">abstract RecursiveFilterIterator extends FilterIterator implements OuterIterator , RecursiveIterator</div><div class="line">RecursiveIteratorIterator implements OuterIterator</div><div class="line">RecursiveRegexIterator extends RegexIterator implements RecursiveIterator</div><div class="line">RecursiveTreeIterator extends RecursiveIteratorIterator implements OuterIterator</div><div class="line">RegexIterator extends FilterIterator</div></pre></td></tr></table></figure></p>
<p>应用举例，遍历目录下面的所有指定后缀的文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">class  RecursiveFileFilterIterator extends FilterIterator&#123;</div><div class="line">	protected $ext = array(&apos;jpg&apos;,&apos;png&apos;,&apos;php&apos;);</div><div class="line"></div><div class="line">	public function __construct($path)&#123;</div><div class="line">		parent::__construct(new RecursiveIteratorIterator(new RecursiveDirectoryIterator($path)));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public function accept()&#123;</div><div class="line">		$item = $this-&gt;getInnerIterator();</div><div class="line">		if($item-&gt;isFile() &amp;&amp; in_array(pathinfo($item-&gt;getFilename(),PATHINFO_EXTENSION), $this-&gt;ext))&#123;</div><div class="line">			return true;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">foreach(new RecursiveFileFilterIterator(&apos;/Users/kivmi/Documents&apos;) as $item)&#123;</div><div class="line">	echo $item.PHP_EOL;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p> 迭代设计模式</p>
<p> 1.创建迭代器<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"> namespace platform;</div><div class="line"></div><div class="line"></div><div class="line">class  PlatformIteratorBlock implements  \Iterator</div><div class="line">&#123;</div><div class="line">    protected  $current = 0;</div><div class="line">    protected  $platformList = null;</div><div class="line"></div><div class="line">    public  function __construct(PlatformBlocks $platformList)</div><div class="line">    &#123;</div><div class="line">        $this-&gt;platformList = $platformList;</div><div class="line">        $this-&gt;current = $this-&gt;platformList-&gt;count() - 1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public  function  current()</div><div class="line">    &#123;</div><div class="line">        return $this-&gt;platformList-&gt;get($this-&gt;current);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public  function key()</div><div class="line">    &#123;</div><div class="line">        return $this-&gt;current;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public  function next()</div><div class="line">    &#123;</div><div class="line">        $this-&gt;current -- ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public  function rewind()</div><div class="line">    &#123;</div><div class="line">        $this-&gt;current = $this-&gt;platformList-&gt;count() - 1;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public  function valid( )</div><div class="line">    &#123;</div><div class="line">        return null != $this-&gt;platformList-&gt;get($this-&gt;current);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>2.创建一个篮子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">namespace platform;</div><div class="line"></div><div class="line">class PlatformBlocks implements  \Countable</div><div class="line">&#123;</div><div class="line">    protected  $platforms =  [];</div><div class="line"></div><div class="line">    public  function get($n)</div><div class="line">    &#123;</div><div class="line">            if(isset($this-&gt;platforms[$n]))</div><div class="line">            &#123;</div><div class="line">                    return $this-&gt;platforms[$n];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            return null;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public function add(PlatformBlock $platform)</div><div class="line">    &#123;</div><div class="line">            $this-&gt;platforms[]  = $platform;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public function remove(PlatformBlock $platform)</div><div class="line">    &#123;</div><div class="line">            foreach ($this-&gt;platforms as $k =&gt; $block)</div><div class="line">            &#123;</div><div class="line">                 if($block-&gt;getName()  == $platform-&gt;getName())</div><div class="line">                 &#123;</div><div class="line">                        unset($this-&gt;platforms[$k]);</div><div class="line">                 &#125;</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public function count()</div><div class="line">    &#123;</div><div class="line">            return  count($this-&gt;platforms);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>3.从篮子里消费<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$platformList = new PlatformListBlock();</div><div class="line">$platformList-&gt;add(new NewsPlatformBlock());</div><div class="line">$iterator = new PlatformIteratorBlock($platformList);</div><div class="line"></div><div class="line">while($iterator-&gt;valid())</div><div class="line">&#123;</div><div class="line">   foreach ($iterator-&gt;current()-&gt;getData() as $params)</div><div class="line">   &#123;</div><div class="line">       self::doRequest($iterator-&gt;current()-&gt;getUrl(), $params);</div><div class="line">   &#125;</div><div class="line">   $iterator-&gt;next();</div><div class="line">&#125;&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2016/12/26/shell脚本日志收集与打包/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/26/shell脚本日志收集与打包/" itemprop="url">
                  shell脚本日志收集与打包
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-26T14:53:35+08:00">
                2016-12-26
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>线上日志收集是很正常的业务，一般由运营来处理，现在给一段代码来实现日志的收集，打包以及上传到s3备份存储，请看代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div></pre></td><td class="code"><pre><div class="line">#!/bin/sh</div><div class="line">function send_sms()</div><div class="line">&#123;</div><div class="line">    . /data/se_scripts/conf/setting_new.conf</div><div class="line">    phone=$phone_number</div><div class="line">    phone=$(echo $phone |sed &apos;s/\n//g&apos;)</div><div class="line">    phone=$(echo $phone |sed &apos;s/\r//g&apos;)</div><div class="line">    sh /data/se_scripts/conf/send_msg_new.sh $&#123;phone&#125; 701 &quot;upload $1 failed&quot; &amp;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function exit_if_timeout()</div><div class="line">&#123;</div><div class="line">    SLEEP_SECONDS=$1</div><div class="line">    CMD=$2</div><div class="line">    #set -x</div><div class="line">    $CMD &amp;</div><div class="line">    pidApp=$!</div><div class="line">    ( sleep $SLEEP_SECONDS ; kill $pidApp ) &amp;</div><div class="line">    killerPid=$!</div><div class="line">    wait $pidApp</div><div class="line">    status=$?</div><div class="line">    (kill -0 $killerPid &amp;&amp; kill $killerPid) || true</div><div class="line">    #set +x</div><div class="line">    return $status</div><div class="line">&#125;</div><div class="line"></div><div class="line">function exec_cmd_with_retry() </div><div class="line">&#123;</div><div class="line">    cmd=$1</div><div class="line">    cur_retry=$2</div><div class="line">    while [ $cur_retry -gt 0 ]; do</div><div class="line">        $cmd</div><div class="line">        ret=$?</div><div class="line">        if [ $ret -eq 0 ]; then</div><div class="line">            return</div><div class="line">        fi</div><div class="line"></div><div class="line">        ((cur_retry -= 1))</div><div class="line">        sleep 10</div><div class="line">    done</div><div class="line">  </div><div class="line">    send_sms &quot;Failed to exec $&#123;cmd&#125; IP:$&#123;local_ip&#125;&quot;</div><div class="line">    exit 1;</div><div class="line">&#125;</div><div class="line"></div><div class="line">function upload_s3path()</div><div class="line">&#123;</div><div class="line">    retry_cnt=$1</div><div class="line">    src_path=$2</div><div class="line">    file=$3</div><div class="line">    arr=($&#123;file//./ &#125;)</div><div class="line">    day=$&#123;file:0:8&#125;</div><div class="line">    hour=$&#123;file:8:2&#125;</div><div class="line">    minute=$&#123;file:10:2&#125;</div><div class="line">    exit_if_timeout 600 &quot;aws s3 cp --profile $s3_profile $src_path/$file $s3_path/$day/$hour/$minute/$file.$local_ip.log&quot; </div><div class="line"></div><div class="line">    ret=$?</div><div class="line">    if [ $ret -eq 0 ] ; then</div><div class="line">        rm -rf $src_path/$file</div><div class="line">    fi</div><div class="line"></div><div class="line">    if [ $ret -eq 0 ] &amp;&amp; [ &quot;$&#123;file&#125;&quot; != &quot;$&#123;ln_file&#125;&quot; ]; then</div><div class="line">        send_sms &quot;$src_path/$file uploads3 retry ok $&#123;local_ip&#125;&quot;</div><div class="line">    elif [ $ret -ne 0 ] &amp;&amp; [ $retry_cnt -eq 0 ]; then</div><div class="line">        send_sms &quot;$src_path/$file uploads3 failed $&#123;local_ip&#125;&quot;</div><div class="line">    fi</div><div class="line">&#125;</div><div class="line"></div><div class="line">function upload_files()</div><div class="line">&#123;</div><div class="line">    for f in `ls $ln_path`</div><div class="line">    do</div><div class="line">        upload_s3path $1 $ln_path $f</div><div class="line">    done</div><div class="line">&#125;</div><div class="line"></div><div class="line">function upload_empty()</div><div class="line">&#123;</div><div class="line">    for f in `ls $lock_touch`</div><div class="line">    do</div><div class="line">        upload_s3path $1 $lock_touch $f</div><div class="line">    done</div><div class="line">&#125;</div><div class="line"></div><div class="line">function upload_logs()</div><div class="line">&#123;</div><div class="line">    cur_retry=5</div><div class="line">    while [ $cur_retry -gt 0 ]; do</div><div class="line">        upload_empty $cur_retry</div><div class="line">        upload_files $cur_retry</div><div class="line">        ((cur_retry -= 1))</div><div class="line">        sleep 10</div><div class="line">    done </div><div class="line">&#125;</div><div class="line"></div><div class="line">#down 机 肯定不会有原始日志，所以不检查原始日志</div><div class="line">function check_empty()</div><div class="line">&#123;</div><div class="line">    for f in `ls $lock_touch`</div><div class="line">    do</div><div class="line">        check=`ls $ln_path | grep  $f | grep -v grep | wc -l`</div><div class="line">        if [ $check -ne 0 ]; then</div><div class="line">            rm -rf $lock_touch/$f</div><div class="line">        fi</div><div class="line">    done</div><div class="line">&#125;</div><div class="line"></div><div class="line">function check_pid()</div><div class="line">&#123;</div><div class="line">    if [ ! -d $&#123;lock_pid&#125; ];then</div><div class="line">        mkdir -p $lock_pid</div><div class="line">        echo $$ &gt; $lock_pid/PID</div><div class="line">        return</div><div class="line">    fi</div><div class="line"></div><div class="line">    check=0</div><div class="line">    running=`cat $lock_pid/PID`</div><div class="line">    if [ ! -z $running  ]; then</div><div class="line">        check=`ps -ef | grep  $running | grep -v grep | wc -l`</div><div class="line">    fi</div><div class="line"></div><div class="line">    if [ &quot;$check&quot; -eq &quot;1&quot; ]; then</div><div class="line">        exit</div><div class="line">    fi</div><div class="line"></div><div class="line">    echo $$ &gt; $lock_pid/PID</div><div class="line">&#125;</div><div class="line"></div><div class="line">#args</div><div class="line">log_path=$1</div><div class="line">log_file=$2</div><div class="line">s3_path=$3</div><div class="line">ln_path=$4</div><div class="line">ln_file=$6</div><div class="line">s3_profile=$7</div><div class="line">lock_pid=$5/pid</div><div class="line">lock_touch=$5/empty</div><div class="line">local_ip=`cat /var/tmp/ifconfigme`</div><div class="line"></div><div class="line">#soft link</div><div class="line">exec_cmd_with_retry &quot;ln -s $log_path/$log_file $ln_path/$ln_file&quot; 5</div><div class="line"></div><div class="line">check_pid</div><div class="line">check_empty</div><div class="line">upload_logs</div><div class="line">rm -rf $lock_pid</div></pre></td></tr></table></figure></p>
<p>基本上已经够用了，需要定义自己的变量就好！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2016/12/25/MerryChristmas/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/25/MerryChristmas/" itemprop="url">
                  MerryChristmas
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-25T22:09:34+08:00">
                2016-12-25
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Merry Christmas！送给我，也送给我未过门的妻子，今天也是我的生日，祝我生日快乐！！</p>
<p>今天和兰兰，在小区门口的香辣居吃了一条烤鱼，味道不错，只是价格稍微贵了点，然后我们去了附近的沃尔玛，虽然兰兰忘记了我的生日，但是我没有怪罪她，只要她在我身边，陪着我，我已经足够了，可是她还是很想给我买一个蛋糕，说毕竟是生日，没有蛋糕咋行，我说我不喜欢吃蛋糕，想作罢，但是她还是很认真的一定要给我买一个，我说那就买一个mini的就好，然后我们去了沃尔玛，选了一个10块钱的蛋糕，4英寸，很实惠，兰兰问我晚上吃面好好，我就知道她是想我健康，长寿，因为她希望我活的比她长，她害怕失去我，一个人很孤独，我还是应了她，我说好啊，然后我们来了虾仁，面条，还有西红柿，鸡蛋家里有，也就没买了，我们回到家，她有点累，然后回家休息！我们一起开始吃蛋糕，然后兰兰说，许个愿吧，我说许愿做什么，最后我还是许个愿，因为这个愿望我想不仅仅属于我，也属于她，希望我的2017会有一个不一样的自己，生活！</p>
<p>我们在一起争吵了许多次，磨合了许多次，也伤感了许多次，但是这些都没能让我们真正的放弃彼此，而是更让我们珍惜彼此！爱，如此的奇妙，因为爱，才有那份征服自己和生活的勇气，因为爱，才不让自己变得没有任何责任心，因为爱，北京的雾霾也不会阻止我们相见！好久没有抒情了，还记得在学校文学社写抒情诗的自己，那么的沉迷，以至于不能自我！可惜，没能长久的保持那份坚持，现在看技术方面的书籍比较多点，都忘了如何去表达！</p>
<p>希望自己的2017，有勇气，有智慧，变得更聪明，更好驾驭自己，走向生活，为爱而生，也为我那可爱的，嫌弃我，陪伴我的人儿，追寻更多的幸福！hello world！hello，2017!</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2016/12/22/关于线上问题/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/22/关于线上问题/" itemprop="url">
                  关于线上问题
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-22T10:01:43+08:00">
                2016-12-22
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>关于线上问题，是真正能够让我们成长的最好的方式，所以需要不断的积累，特别是大数据量时引起的一系列问题，包括人为的和线上的：</p>
<p>1.个人行为造成的问题，某同学想修改下数据表字段的类型，修改了一个几百万数据量的表，修改过程中会导致SQL阻塞，进一步导致请求阻塞，以至于整个系统请求平均延迟上升，产生了蝴蝶效应。如果量级更大的话，影响时间会更长，以至于整个系统不可用<br>总结：<br>线上的大表，因为都是基于innodb存储引起，修改引起的代价是比较大的，可能会锁表，索引尽可能的少执行这种操作，需要做好测试评估好执行影响时间</p>
<p>2.应用场景引发的问题，对于直播产品，视频直播结束，会向观众发送直播已经结束的消息，而这种消息是同时发送的，这样就会引起大量的数据产生和消费，造成的影响是，服务器消息堆积，客户端不知道直播是否结束，客户端仍然还在聊天室<br>总结：<br>在一定的时间内，比如1min, 离散的发送消息，让客户端能够在有限的时间内退出聊天室，不至于影响产品的用户体验</p>
<p>3.redis错误，read error on connection<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PHP Fatal error:  Uncaught exception &apos;RedisException&apos; with message &apos;read error on connection&apos; in ....</div></pre></td></tr></table></figure></p>
<p>这个错误是偶尔遇到，有同学通过修改php soctet超时时间来修复该问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">default_socket_timeout = 60</div></pre></td></tr></table></figure></p>
<p>或者在脚本中添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ini_set(&apos;default_socket_timeout&apos;, -1);  //不超时</div></pre></td></tr></table></figure></p>
<p>来解决该问题,但是这种解决方式并不是最好，而且这种方式需要重启php-fpm进程才可以生效</p>
<p>4.服务配置引起的问题，新开一个elb,支持cloudfront CDN支持，针对某个地区，将xxx.xxx.net这个域名，解析到cloudfront地址上，经由cloudfront再到后端elb进行访问，出现服务访问不了的情况，经运维协查，是cloude front服务配置问题导致<br>总结：<br>线上配置，需要谨慎修改，支持各种环境（线上，开发，测试，联调）发布部署配置文件的管理</p>
<p>5.设计问题，redis大key如何解，有时候对于好友关系等出现长尾数据的时候，存和读都会遇到问题，一般对大key的读，使用分页读，如果存储的数据量过大，1000w,那么做数据迁移还是数据恢复就会有问题，所以，单key的数据量的存储，不应过大<br>总结：<br>大key,可以使用应用层对id进行hash，生成统一前缀的key，自动实现key的查找</p>
<p>6.高并发，大数据引起最初设计的变化的问题，随着用户量的增加，uv上升，导致之前的设计请求量增加，系统压力增大，这样需要在原先的设计上，增加一些策略，当然，这种策略的增加需要产品的支持，比如消息发送，对任何用户等级之间的用户发送私信，当大网红直播时，这样导致消息量剧增，如果同时直播数比较多，产生的消息量会非常大，这样，可以增加一些策略来减少这种压力，比如只有达到某个等级的用户，在直播的时候，才对其粉丝发送私信，这样就大大的减少了消息量的产生，当然也可以在技术上支持</p>
<p>7.减少存储系统的压力，对于给予协助处理服务程序的数据，比如算法，这种服务的特性是非实时的，或者接近实时，对于这种数据的存储，不需要放到内存中存储，可以使用kafka来存储，将算法服务接入该系统，获取数据，并将数据的结果写入前端服务器或者内存中，供前端服务使用</p>
<p>8.线上日志，一种为数据日志，提供分析平台使用，而另外一种属于业务日志，供问题定位，对于业务日志，需要做到能准确定位所发生的问题，用户线上问题排查</p>
<p>9.无状态设计和有状态设计，无状态设计，比如静态文件，或者使用已有的信息，能拿到所需要的静态资源数据信息，怎样区权衡是使用有状态设计，还是使用无状态设计，还是有无状态设计相结合，需要考虑到对系统性能的影响，有多大的影响，增加有状态设计会产生什么多大的存储资源的损耗？是否是热点数据，是否需要将数据分多次多状态存储和维护？如果数据量不大，而且是基于热点，那么最好还是使用有状态设计，不会产生太多的资源损耗问题，性能还是实现的逻辑也是可以控制的</p>
<p>10.系统架构设计，使用ha来实现各节点之间活跃监控，增强系统的容错处理和可靠性</p>
<p>11.redis并发症控制，可以使用setnx来替换set</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2016/12/20/go基础/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/20/go基础/" itemprop="url">
                  go基础
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-20T13:14:35+08:00">
                2016-12-20
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2016/12/11/linux的10个命令/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/11/linux的10个命令/" itemprop="url">
                  linux的10个命令
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-11T00:20:53+08:00">
                2016-12-11
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先看下这个10个命令：<br>uptime<br>dmesg | tail<br>vmstat 1<br>mpstat -P ALL 1<br>pidstat 1<br>iostat -xz 1<br>free -m<br>sar -n DEV 1<br>sar -n TCP,ETCP 1<br>top</p>
<p>下面讲解下这个10个命令都是用来做什么的，怎么用</p>
<p>uptime</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">chenjingxiu:~ kivmi$ uptime</div><div class="line">00:23上午  up 6 days  1:53,  3 users,  load average: 1.96, 1.70, 1.70</div></pre></td></tr></table></figure>
<p>uptime – show how long system has been running<br>DESCRIPTION<br>     The uptime utility displays the current time, the length of time the system has been up, the number of users, and the load average of the system over the<br>          last 1, 5, and 15 minutes.<br>该命令用来查看系统的运行时间和负载情况，分别对应以下列<br>当前时间  启动运行时间 系统启动时间  当前系统用户数   系统最近1分钟、5分钟、15分钟系统的负载情况</p>
<p>dmesg | tail<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">chenjingxiu:~ kivmi$ sudo  dmesg | tail</div><div class="line">ARPT: 243830.149501: DequeueTime: 0x1906f048 LastTxTime: 0x1ff947d1 PHYTxErr:   0x0000 RxAckRSSI: 0x0000 RxAckSQ: 0x0000</div><div class="line">ARPT: 243830.149527: Raw[0]    1 Valid</div><div class="line">ARPT: 243830.149536: [2]    0 IM</div><div class="line">ARPT: 243830.149541: [3]    1 PM</div><div class="line">ARPT: 243830.149545: [7-4]  0 Suppr</div><div class="line">ARPT: 243830.149550: [14:8] 1 Ncons</div><div class="line">ARPT: 243830.149555: [15]   0 Acked</div><div class="line">ARPT: 243830.149561: txpktpend AC_BK 0 AC_BE 0 AC_VI 0 AC_VO 1 BCMC 0 ATIM 0</div><div class="line">SmartBattery: finished polling type 4</div><div class="line">UserEventAgent is not entitledUserEventAgent is not entitledloginwindow is not entitledloginwindow is not entitledUserEventAgent is not entitledUserEventAgent is not entitledloginwindow is not entitledloginwindow is not entitledUserEventAgent is not entitledUserEventAgent is not entitledloginwindow is not entitledloginwindow is not entitledSmartBattery: finished polling type 4</div></pre></td></tr></table></figure></p>
<p>dmesg – display the system message buffer<br>DESCRIPTION<br>     Dmesg displays the contents of the system message buffer.  This command needs to be run as root.<br>该命令用来显示linux内核的环形缓冲区(kernel ring buffer)信息,从中获得诸如系统架构、cpu、挂载的硬件，RAM等多个运行级别的大量的系统信息,当计算机启动时，系统内核（操作系统的核心部分）将会被加载到内存中,在加载的过程中会显示很多的信息，在这些信息中我们可以看到内核检测硬件设备，主要是硬件检测，包括磁盘sda,hda,usb等</p>
<p>vmstat 2 1<br>每两秒采集一次服务器的状态 2 时间间隔 1 次数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[chenjingxiu@op ~]$ vmstat 1  3</div><div class="line">procs    -----------memory----------  ---swap-- -----io---- --system-- -----cpu-----</div><div class="line">r  b    swpd   free   buff  cache     si   so    bi    bo   in   cs us sy id wa st</div><div class="line">0  0      0 5564792 408260 20643368    0    0     0    27    1    1  1  2 97  0  0</div><div class="line">0  0      0 5562248 408260 20643372    0    0     0     0 2609 3087  1  2 98  0  0</div><div class="line">6  0      0 5530268 408260 20643380    0    0     0     0 4354 4287  4  6 90  0  0</div></pre></td></tr></table></figure></p>
<p>NAME<br>       vmstat - Report virtual memory statistics</p>
<p>SYNOPSIS<br>       vmstat [-a] [-n] [-t] [-S unit] [delay [ count ]]<br>       vmstat [-s] [-n] [-S unit]<br>       vmstat [-m] [-n] [delay [ count ]]<br>       vmstat [-d] [-n] [delay [ count ]]<br>       vmstat [-p disk partition] [-n] [delay [ count ]]<br>       vmstat [-f]<br>       vmstat [-V]</p>
<p>DESCRIPTION<br>       vmstat reports information about processes, memory, paging, block IO, traps, and cpu activity.The  first  report produced gives averages since the last reboot.  Additional reports give information on a sampling period of length delay.  The process and memory<br>                     reports are instantaneous in either case.</p>
<p>DESCRIPTION FOR VM MODE</p>
<p>Procs<br>    r: The number of processes waiting for run time.(在运行队列中等待cpu进程数)<br>    b: The number of processes in uninterruptible sleep.(等待I/O的进程数)</p>
<p>Memory<br>    swpd: the amount of virtual memory used.(切换到内存交换区的内存数量,如果swpd比较大，但是si,so一直为0，系统性能也是正常的)<br>    free: the amount of idle memory.<br>    buff: the amount of memory used as buffers.(一般对块设备的读写进行缓存)<br>    cache: the amount of memory used as cache.(page cache数量，一般作为文件系统的缓存，如果cache比较大，说明用到cache的文件比较多，如果I/O的bi比较小，说明文件系统效率比较好)<br>    inact: the amount of inactive memory. (-a option)<br>    active: the amount of active memory. (-a option)</p>
<p>Swap<br>    si: Amount of memory swapped in from disk (/s).(从磁盘交换进内存的页数量)<br>    so: Amount of memory swapped to disk (/s).(从内存交换到磁盘的页数量)</p>
<p>IO<br>    bi: Blocks received from a block device (blocks/s).(从磁盘读到内存的块数)<br>    bo: Blocks sent to a block device (blocks/s).(从内存写入磁盘的块数)</p>
<p>System<br>    in: The number of interrupts per second, including the clock.(每秒设备中断数)<br>    cs: The number of context switches per second.(每秒产生的上下文切换次数，cs正常情况下，应小于I/O的包传输速率)</p>
<p>CPU<br>    These are percentages of total CPU time.<br>    us: Time spent running non-kernel code. (user time, including nice time) (用户进程占用cpu的时间比)<br>    sy: Time spent running kernel code. (system time) (系统进程占用cpu的时间比)<br>    id: Time spent idle. Prior to Linux 2.5.41, this includes IO-wait time.(中央处理器空闲时间占用比)<br>    wa: Time spent waiting for IO. Prior to Linux 2.5.41, included in idle.<br>    st: Time stolen from a virtual machine. Prior to Linux 2.6.11, unknown.</p>
<p>FIELD DESCRIPTION FOR DISK MODE</p>
<p>Reads<br>    total: Total reads completed successfully<br>    merged: grouped reads (resulting in one I/O)<br>    sectors: Sectors read successfully<br>    ms: milliseconds spent reading</p>
<p>Writes<br>    total: Total writes completed successfully<br>    merged: grouped writes (resulting in one I/O)<br>    sectors: Sectors written successfully<br>    ms: milliseconds spent writing</p>
<p>IO<br>    cur: I/O in progress<br>    s: seconds spent for I/O<br>    ms: milliseconds spent writing</p>
<p>IO<br>    cur: I/O in progress<br>    s: seconds spent for I/O</p>
<p>FIELD DESCRIPTION FOR DISK PARTITION MODE</p>
<pre><code>reads: Total number of reads issued to this partition read sectors: Total read sectors for partition
writes : Total number of writes issued to this partition
requested writes: Total number of write requests made for partition
</code></pre><p>FIELD DESCRIPTION FOR SLAB MODE</p>
<pre><code>cache: Cache name
num: Number of currently active objects
total: Total number of available objects
size: Size of each object
pages: Number of pages with at least one active object
totpages: Total number of allocated pages
pslab: Number of pages per slab
</code></pre><p>如果r经常大于4 ，且id经常小于40，表示中央处理器的负荷很重。 如果bi，bo 长期不等于0，表示物理内存容量太小</p>
<p>mpstat -P ALL 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[chenjingxiu@op ~]$ mpstat -P ALL 1</div><div class="line">Linux 2.6.32-279.19.1.el6.centos.plus.x86_64 (op.liebaopay.com)         12/11/2016      _x86_64_        (8 CPU)</div><div class="line"></div><div class="line">06:49:57 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest   %idle</div><div class="line">06:49:58 AM  all    0.50    0.00    1.00    0.50    0.00    0.00    0.00    0.00   97.99</div><div class="line">06:49:58 AM    0    1.01    0.00    1.01    1.01    0.00    0.00    0.00    0.00   96.97</div><div class="line">06:49:58 AM    1    1.00    0.00    1.00    3.00    0.00    0.00    0.00    0.00   95.00</div><div class="line">06:49:58 AM    2    0.00    0.00    2.02    0.00    0.00    0.00    0.00    0.00   97.98</div><div class="line">06:49:58 AM    3    0.99    0.00    0.99    0.00    0.00    0.00    0.00    0.00   98.02</div><div class="line">06:49:58 AM    4    0.99    0.00    0.99    0.00    0.00    0.00    0.00    0.00   98.02</div><div class="line">06:49:58 AM    5    0.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00   99.00</div><div class="line">06:49:58 AM    6    0.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00   99.00</div><div class="line">06:49:58 AM    7    0.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00   99.00</div><div class="line"></div><div class="line">06:49:58 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest   %idle</div><div class="line">06:49:59 AM  all    0.50    0.00    1.51    0.00    0.00    0.00    0.00    0.00   97.99</div><div class="line">06:49:59 AM    0    2.97    0.00    5.94    0.00    0.00    0.00    0.00    0.00   91.09</div><div class="line">06:49:59 AM    1    0.00    0.00    1.02    0.00    0.00    0.00    0.00    0.00   98.98</div><div class="line">06:49:59 AM    2    0.99    0.00    1.98    0.00    0.00    0.00    0.00    0.00   97.03</div><div class="line">06:49:59 AM    3    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00</div><div class="line">06:49:59 AM    4    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00</div><div class="line">06:49:59 AM    5    0.00    0.00    1.01    0.00    0.00    0.00    0.00    0.00   98.99</div><div class="line">06:49:59 AM    6    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00</div><div class="line">06:49:59 AM    7    0.00    0.00    1.00    0.00    0.00    0.00    0.00    0.00   99.00</div></pre></td></tr></table></figure></p>
<p>NAME<br>    mpstat - Report processors related statistics.</p>
<p>DESCRIPTION<br>    The mpstat command writes to standard output activities for each available processor, processor 0 being the first one.  Global average activities among all processors are also reported.  The mpstat command can be used both on SMP and UP machines, but in the  latter,  only  global  average  activities  will  be printed. If no activity has been selected, then the default report is the CPU utilization report.<br>    The  interval  parameter  specifies  the  amount  of time in seconds between each report.  A value of 0 (or no parameters at all) indicates that processors statistics are to be reported for the time since system startup (boot).  The count parameter can be specified in conjunction with the interval parameter if  this  one  is not set to zero. The value of count determines the number of reports generated at interval seconds apart. If the interval parameter is speci-fied without the count parameter, the mpstat command generates reports continuously.</p>
<p>OPTIONS<br>    -A     This option is equivalent to specifying -I ALL -u -P ALL<br>    -P { cpu [,…] | ON | ALL  }<br>    Indicate the processor number for which statistics are to be reported.  cpu is the processor number. Note that processor 0 is the  first  processor.The  ON keyword indicates that statistics are to be reported for every online processor, whereas the ALL keyword indicates that statistics are to be reported for all processors.<br>    -u     Report CPU utilization. The following values are displayed:</p>
<pre><code>CPU Processor number. The keyword all indicates that statistics are calculated as averages among all processors.
%usr Show the percentage of CPU utilization that occurred while executing at the user level (application).
%nice Show the percentage of CPU utilization that occurred while executing at the user level with nice priority.
%sys Show the percentage of CPU utilization that occurred while executing at the system level (kernel). Note that this does not include time spent servicing hardware and software interrupts.
%iowait Show the percentage of time that the CPU or CPUs were idle during which the system had an outstanding disk I/O request.
%irq Show the percentage of time spent by the CPU or CPUs to service hardware interrupts.
%soft Show the percentage of time spent by the CPU or CPUs to service software interrupts.
%steal Show  the  percentage of time spent in involuntary wait by the virtual CPU or CPUs while the hypervisor was servicing another virtual proces-sor.
%guest Show the percentage of time spent by the CPU or CPUs to run a virtual processor.
%idle Show the percentage of time that the CPU or CPUs were idle and the system did not have an outstanding disk I/O request.
</code></pre><p>ipdstat 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[chenjingxiu@op ~]$ pidstat 1</div><div class="line">Linux 2.6.32-279.19.1.el6.centos.plus.x86_64 (op.liebaopay.com)         12/11/2016      _x86_64_        (8 CPU)</div><div class="line"></div><div class="line">07:01:34 AM       PID    %usr %system  %guest    %CPU   CPU  Command</div><div class="line">07:01:35 AM      3294    0.00    0.84    0.00    0.84     3  python2.7</div><div class="line">07:01:35 AM     14733    0.84    0.00    0.00    0.84     0  sshd</div><div class="line">07:01:35 AM     15959    4.20   11.76    0.00   15.97     0  pidstat</div><div class="line">07:01:35 AM     30156    0.00    0.84    0.00    0.84     1  tmux</div><div class="line"></div><div class="line">07:01:35 AM       PID    %usr %system  %guest    %CPU   CPU  Command</div><div class="line">07:01:36 AM        36    0.00    1.00    0.00    1.00     1  events/1</div><div class="line">07:01:36 AM     14733    0.00    1.00    0.00    1.00     0  sshd</div><div class="line">07:01:36 AM     15959    5.00   13.00    0.00   18.00     0  pidstat</div><div class="line">07:01:36 AM     29962    1.00    0.00    0.00    1.00     0  python</div></pre></td></tr></table></figure></p>
<p>NAME<br>       pidstat - Report statistics for Linux tasks.</p>
<p>DESCRIPTION<br>The pidstat command is used for monitoring individual tasks currently being managed by the Linux kernel.  It writes to standard output activities for every task  selected with option -p or for every task managed by the Linux kernel if option -p ALL has been used. Not selecting any tasks is equivalent to speci-fying -p ALL but only active tasks (tasks with non-zero statistics values) will appear in the report.</p>
<p>The pidstat command can also be used for monitoring the child processes of selected tasks.  Read about option -T below.</p>
<p>The interval parameter specifies the amount of time in seconds between each report.  A value of 0 (or no parameters at all) indicates that tasks statistics are  to  be reported for the time since system startup (boot).  The count parameter can be specified in conjunction with the interval parameter if this one is not set to zero. The value of count determines the number of reports generated at interval seconds apart. If the interval parameter is specified without the count parameter, the pidstat command generates reports continuously.</p>
<p>You can select information about specific task activities using flags.  Not specifying any flags selects only CPU activity.</p>
<p>EXAMPLES</p>
<p>pidstat 2 5<br>    Display five reports of CPU statistics for every active task in the system at two second intervals.</p>
<p>pidstat -r -p 1643 2 5<br>    Display five reports of page faults and memory statistics for PID 1643 at two second intervals.</p>
<p>pidstat -T CHILD -r 2 5<br>    Display five reports of page faults statistics at two second intervals for the child processes of all tasks in the system. Only child processes with non-zero statistics values are displayed.</p>
<p>iostat -xz 1<br>iostat主要用于监控系统设备的IO负载情况<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">chenjingxiu:~ kivmi$ iostat -d -K 1 10</div><div class="line">disk0               disk2               disk3 </div><div class="line">KB/t  tps  MB/s     KB/t  tps  MB/s     KB/t  tps  MB/s </div><div class="line">52.04    6  0.31    14.14    0  0.00    14.03    0  0.00 </div><div class="line">4.00    9  0.04     0.00    0  0.00     0.00    0  0.00 </div><div class="line">6.67    3  0.02     0.00    0  0.00     0.00    0  0.00 </div><div class="line">4.00    1  0.00     0.00    0  0.00     0.00    0  0.00 </div><div class="line">394.00    2  0.77     0.00    0  0.00     0.00    0  0.00 </div><div class="line"></div><div class="line">[chenjingxiu@op ~]$ iostat -xz 1</div><div class="line">Linux 2.6.32-279.19.1.el6.centos.plus.x86_64 (op.liebaopay.com)         12/11/2016      _x86_64_        (8 CPU)</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">1.08    0.00    1.92    0.13    0.01   96.86</div><div class="line"></div><div class="line">Device:         rrqm/s   wrqm/s     r/s     w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util</div><div class="line">xvda              0.00     0.09    0.03    7.72     0.89    62.49     8.18     0.05    6.19   1.23   0.95</div><div class="line">xvdi              0.00     9.52    0.03    6.74     2.13   130.09    19.52     0.09   12.73   0.51   0.34</div><div class="line">xvdb              0.00     0.00    0.01    0.12     0.12     9.44    73.96     0.04  304.96   2.07   0.03</div><div class="line">xvdf              0.00     0.01    0.06    3.31     3.25   229.37    69.16     0.03    8.61   0.17   0.06</div><div class="line"></div><div class="line">avg-cpu:  %user   %nice %system %iowait  %steal   %idle</div><div class="line">0.38    0.00    0.75    0.25    0.13   98.50</div><div class="line"></div><div class="line">Device:         rrqm/s   wrqm/s     r/s     w/s   rsec/s   wsec/s avgrq-sz avgqu-sz   await  svctm  %util</div><div class="line">xvda              0.00     0.00    1.00    0.00    16.00     0.00    16.00     0.02   17.00  17.00   1.70</div></pre></td></tr></table></figure></p>
<p>NAME<br>    iostat - Report Central Processing Unit (CPU) statistics and input/output statistics for devices, partitions and network filesystems (NFS).</p>
<p>DESCRIPTION<br>    The  iostat  command is used for monitoring system input/output device loading by observing the time the devices are active in relation to their average transfer rates. The iostat command generates reports that can be used to change system configuration to better balance the input/output load between physical disks.</p>
<p>The first report generated by the iostat command provides statistics concerning the time since the system was booted. Each  subsequent  report  covers  the  time since  the  previous  report.  All  statistics are reported each time the iostat command is run. The report consists of a CPU header row followed by a row of CPU statistics. On multiprocessor systems, CPU statistics are calculated system-wide as averages among all processors. A device header row is displayed followed by a line  of statistics for each device that is configured.  When option -n is used, an NFS header row is displayed followed by a line of statistics for each network filesystem that is mounted.</p>
<p>The interval parameter specifies the amount of time in seconds between each report. The first report contains  statistics  for  the  time  since  system  startup (boot).  Each  subsequent report contains statistics collected during the interval since the previous report. The count parameter can be specified in conjunction with the interval parameter. If the count parameter is specified, the value of count determines the number of reports generated at interval seconds apart. If the interval parameter is specified without the count parameter, the iostat command generates reports continuously.</p>
<p>REPORTS<br>    The iostat command generates three types of reports, the CPU Utilization report, the Device Utilization report and the Network Filesystem report.</p>
<p>CPU Utilization Report<br>    The  first  report generated by the iostat command is the CPU Utilization Report. For multiprocessor systems, the CPU values are global averages among all processors.  The report has the following format:<br>%user<br>Show the percentage of CPU utilization that occurred while executing at the user level (application).</p>
<p>%nice<br>Show the percentage of CPU utilization that occurred while executing at the user level with nice priority.</p>
<p>%system<br>Show the percentage of CPU utilization that occurred while executing at the system level (kernel).</p>
<p>%iowait<br>Show the percentage of time that the CPU or CPUs were idle during which the system had an outstanding disk I/O request.</p>
<p>%steal<br>Show the percentage of time spent in involuntary wait by the virtual CPU or CPUs while the hypervisor was servicing another virtual processor.</p>
<p>%idle<br>Show the percentage of time that the CPU or CPUs were idle and the system did not have an outstanding disk I/O request.</p>
<p>Device Utilization Report<br>    The second report generated by the iostat command is the Device Utilization Report. The device report provides statistics on a per physical device or par-tition  basis.  Block  devices  for which statistics are to be displayed may be entered on the command line. Partitions may also be entered on the command line providing that option -x is not used.  If no device nor partition is entered, then statistics are displayed for every device used by the system,  and providing  that  the  kernel maintains statistics for it.  If the ALL keyword is given on the command line, then statistics are displayed for every device defined by the system, including those that have never been used.  The report may show the following fields, depending on the flags used.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">tps: 每秒传输的次数，一次传输即一次I/O请求（多个逻辑请求可以合并为一次I/O请求)</div><div class="line">kB_read/s: 每秒从设备读取的数据量</div><div class="line">kB_wrtn/s: 每秒向设备写入的数据量</div><div class="line">kB_read: 读取的总数据量</div><div class="line">kB_wrtn: 写入的总数据量</div><div class="line">rrqm/s：每秒这个设备相关的读取请求有多少被Merge了</div><div class="line">wrqm/s：每秒这个设备相关的写入请求有多少被Merge了</div><div class="line">rsec/s：每秒读取的扇区数</div><div class="line">wsec/：每秒写入的扇区数</div><div class="line">rKB/s：The number of read requests that were issued to the device per second</div><div class="line">wKB/s：The number of write requests that were issued to the device per second</div><div class="line">avgrq-sz：平均请求扇区的大小</div><div class="line">avgqu-sz：平均请求队列的长度</div><div class="line">await：每一个IO请求的处理的平均时间（单位是微秒毫秒)，即IO的响应时间,一般情况下，await大于svctm，两者差值越小，则说明队列时间越短，反之差值越大，队列时间越长,说明系统出问题了，await一般低于5ms</div><div class="line">svctm：表示平均每次设备I/O操作的服务时间（以毫秒为单位)，如果svctm的值与await很接近，表示几乎没有I/O等待，磁盘性能很好，如果await的值远高于svctm的值，则表示I/O队列等待太长，系统上运行的应用程序将变慢</div><div class="line">%util： 在统计时间内所有处理IO时间，除以总共统计时间，预示设备的繁忙程度，如果该参数是100%表示设备已经接近满负荷运行了</div></pre></td></tr></table></figure>
<p>Network Filesystem report<br>    The Network Filesystem (NFS) report provides statistics for each mounted network filesystem.  The report shows the following fields </p>
<p>OPTIONS<br>    -c     Display the CPU utilization report.<br>    -d     Display the device utilization report.(显示磁盘的使用状态)<br>    -K     对块设备，强制使用Kilobytes为单位<br>    -x     Display  extended  statistics.  This option works with post 2.5 kernels since it needs /proc/diskstats file or a mounted sysfs to get the statistics. This option may also work with older kernels (e.g. 2.4) only if extended statistics are available in /proc/partitions (the  kernel  needs  to  be  patched  for that).(显示I/O相关的扩展数据)<br>    -n     Display the network filesystem (NFS) report. This option works only with kernel 2.6.17 and later.<br>    -p [ { device [,…] | ALL  }  ]<br>        The  -p  option  displays  statistics  for block devices and all their partitions that are used by the system.  If a device name is entered on the command line, then statistics for it and all its partitions are displayed. Last, the ALL keyword indicates that statistics have to be displayed for all the  block devices and partitions defined by the system, including those that have never been used.  Note that this option works only with post 2.5 kernels.</p>
<p>EXAMPLES</p>
<pre><code>iostat
Display a single history since boot report for all CPU and Devices.
iostat -d 2
Display a continuous device report at two second intervals.
iostat -d 2 6
Display six reports at two second intervals for all devices.
iostat -x hda hdb 2 6
Display six reports of extended statistics at two second intervals for devices hda and hdb.
iostat -p sda 2 6
Display six reports at two second intervals for device sda and all its partitions (sda1, etc.)
</code></pre><p>主要看await和%util的值，await是否大于5ms，%util是否大于80%</p>
<p>free -m<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[chenjingxiu@op ~]$ free -m </div><div class="line">total       used       free     shared    buffers     cached</div><div class="line">Mem:         30100      24655       5445          0        398      20166</div><div class="line">-/+ buffers/cache:       4089      26010</div><div class="line">Swap:            0          0          0</div></pre></td></tr></table></figure></p>
<p>NAME<br>       free - Display amount of free and used memory in the system<br>DESCRIPTION<br>       free  displays  the  total  amount  of free and used physical and swap memory in the system, as well as the buffers used by the kernel.  The shared memory column should be ignored; it is obsolete.</p>
<p>sar -n DEV 1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[chenjingxiu@op ~]$ sar -n DEV 1</div><div class="line">Linux 2.6.32-279.19.1.el6.centos.plus.x86_64 (op.liebaopay.com)         12/11/2016      _x86_64_        (8 CPU)</div><div class="line"></div><div class="line">07:26:36 AM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s</div><div class="line">07:26:37 AM        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00</div><div class="line">07:26:37 AM      eth0    150.51    152.53     29.42     21.03      0.00      0.00      0.00</div><div class="line"></div><div class="line">07:26:37 AM     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s   txcmp/s  rxmcst/s</div><div class="line">07:26:38 AM        lo      0.00      0.00      0.00      0.00      0.00      0.00      0.00</div><div class="line">07:26:38 AM      eth0    107.00    103.00     24.87     14.36      0.00      0.00      0.00</div></pre></td></tr></table></figure></p>
<p>NAME<br>       sar - Collect, report, or save system activity information.</p>
<p>DESCRIPTION<br>The  sar  command  writes to standard output the contents of selected cumulative activity counters in the operating system. The accounting system, based on the values in the count and interval parameters, writes information the specified number of times spaced at the specified intervals  in  seconds.   If  the interval  parameter is set to zero, the sar command displays the average statistics for the time since the system was started. If the interval parameter is specified without the count parameter, then reports are generated continuously.  The collected data can also be saved in the file specified by the -o file-name  flag,  in  addition  to  being  displayed  onto  the  screen.  If  filename  is  omitted,  sar uses the standard system activity daily data file, the /var/log/sa/sadd file, where the dd parameter indicates the current day.  By default all the data available from the kernel are saved in the data file.</p>
<p>The sar command extracts and writes to standard output records previously saved in a file. This file can be either the one specified by the -f flag or,  by default, the standard system activity daily data file.</p>
<p>Without the -P flag, the sar command reports system-wide (global among all processors) statistics, which are calculated as averages for values expressed as percentages, and as sums otherwise. If the -P flag is given, the sar command reports activity which relates to the specified processor or processors. If -P ALL is given, the sar command reports statistics for each individual processor and global statistics among all processors.</p>
<p>You  can  select  information  about specific system activities using flags. Not specifying any flags selects only CPU activity.  Specifying the -A flag is equivalent to specifying -bBdqrRSvwWy -I SUM -I XALL -n ALL -u ALL -P ALL.</p>
<p>The default version of the sar command (CPU utilization report) might be one of the first facilities the user runs to begin system activity  investigation,because it monitors major system resources. If CPU utilization is near 100 percent (user + nice + system), the workload sampled is CPU-bound.If  multiple samples and multiple reports are desired, it is convenient to specify an output file for the sar command.  Run the sar command as a background process. The syntax for this is:</p>
<p>sar -o datafile interval count &gt;/dev/null 2&gt;&amp;1 &amp;</p>
<pre><code>All data is captured in binary form and saved to a file (datafile).  The data can then be selectively displayed with the sar command using the  -f  option.Set the interval and count parameters to select count records at interval second intervals. If the count parameter is not set, all the records saved in the file will be selected.  Collection of data in this manner is useful to characterize system usage over a period of time and determine peak usage hours.
</code></pre><p>Indicate  the  number  of  transfers  per second that were issued to the device.  Multiple logical requests can be combined into a single I/O<br>request to the device. A transfer is of indeterminate size.</p>
<p>rd_sec/s<br>Number of sectors read from the device. The size of a sector is 512 bytes.</p>
<p>wr_sec/s<br>Number of sectors written to the device. The size of a sector is 512 bytes.</p>
<p>avgrq-sz<br>The average size (in sectors) of the requests that were issued to the device.</p>
<p>avgqu-sz<br>The average queue length of the requests that were issued to the device.</p>
<p>await<br>The average time (in milliseconds) for I/O requests issued to the device to be served. This includes the time spent by the requests in  queue<br>and the time spent servicing them.</p>
<p>svctm<br>The average service time (in milliseconds) for I/O requests that were issued to the device.</p>
<p>%util<br>Percentage  of  CPU time during which I/O requests were issued to the device (bandwidth utilization for the device). Device saturation occurs<br>when this value is close to 100%.</p>
<p> sar -n TCP,ETCP 1<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[chenjingxiu@op ~]$  sar -n TCP,ETCP 1</div><div class="line">Linux 2.6.32-279.19.1.el6.centos.plus.x86_64 (op.liebaopay.com)         12/11/2016      _x86_64_        (8 CPU)</div><div class="line"></div><div class="line">07:38:52 AM  active/s passive/s    iseg/s    oseg/s</div><div class="line">07:38:53 AM      0.00      0.00    122.22    114.14</div><div class="line"></div><div class="line">07:38:52 AM  atmptf/s  estres/s retrans/s isegerr/s   orsts/s</div><div class="line">07:38:53 AM      0.00      0.00      0.00      0.00      0.00</div></pre></td></tr></table></figure></p>
<p>top<br> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">top - 07:40:00 up 47 days, 23:57, 122 users,  load average: 2.01, 2.03, 2.06</div><div class="line">Tasks: 2185 total,   1 running, 2174 sleeping,   8 stopped,   2 zombie</div><div class="line">Cpu(s):  0.9%us,  2.2%sy,  0.0%ni, 96.9%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st</div><div class="line">Mem:  30822952k total, 25263368k used,  5559584k free,   408320k buffers</div><div class="line">Swap:        0k total,        0k used,        0k free, 20652508k cached</div><div class="line"></div><div class="line">PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                                                                </div><div class="line">11028 chenjing  20   0 18732 2928  972 R  3.2  0.0   0:00.48 top                                                                                                                     </div><div class="line">3294 ansible   20   0  635m  49m 2928 S  1.3  0.2 525:49.41 python2.7</div></pre></td></tr></table></figure></p>
<p>NAME<br>       top - display Linux tasks</p>
<p>a: PID  –  Process Id<br>The task’s unique process ID, which periodically wraps, though never restarting at zero.</p>
<p>b: PPID  –  Parent Process Pid<br>The process ID of a task’s parent.</p>
<p>c: RUSER  –  Real User Name<br>The real user name of the task’s owner.</p>
<p>d: UID  –  User Id<br>The effective user ID of the task’s owner.</p>
<p>e: USER  –  User Name<br>The effective user name of the task’s owner.</p>
<p>f: GROUP  –  Group Name<br>The effective group name of the task’s owner.</p>
<p>g: TTY  –  Controlling Tty<br>The  name  of  the  controlling terminal.  This is usually the device (serial port, pty, etc.) from which the process was started, and which it uses for input or output.  However, a task need not be associated with a terminal, in which case you’ll see ’?’ displayed.</p>
<p>h: PR  –  Priority<br>The priority of the task.</p>
<p>i: NI  –  Nice value<br>The nice value of the task.  A negative nice value means higher priority, whereas a positive nice value means lower priority.  Zero in this field simply means priority will not be adjusted in determining a task’s dispatchability.</p>
<p>j: P  –  Last used CPU (SMP)<br>A  number  representing  the last used processor.  In a true SMP environment this will likely change frequently since the kernel intentionally uses weak affinity.  Also, the very act of running top may break this weak affinity and cause more processes to change CPUs  more  often  (because  of  the  extra demand for cpu time).</p>
<p>k: %CPU  –  CPU usage<br>The task’s share of the elapsed CPU time since the last screen update, expressed as a percentage of total CPU time.  In a true SMP environment, if ’Irixmode’ is Off, top will operate in ’Solaris mode’ where a task’s cpu usage will be divided by the total number of CPUs.  You toggle ’Irix/Solaris’  modes with the ’I’ interactive command.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">us 用户空间占用CPU百分比</div><div class="line">sy 内核空间占用cpu百分比</div><div class="line">ni 用户空间内改变优先级的进程占用cpu百分比</div><div class="line">id cpu空闲占用百分比</div><div class="line">wa 等待输入输出的cpu占用百分比</div><div class="line">hi 硬件cpu中断占用百分比</div><div class="line">si 软中断占用百分比</div><div class="line">st 虚拟机占用百分比</div></pre></td></tr></table></figure></p>
<p>l: TIME  –  CPU Time 进程使用cpu时间总计,单位秒<br>Total CPU time the task has used since it started.  When ’Cumulative mode’ is On, each process is listed with the cpu time that it and its dead children has used.  You toggle ’Cumulative mode’ with ’S’, which is a command-line option and an interactive command.  See the ’S’ interactive command for  addi-tional information regarding this mode.</p>
<p>m: TIME+  –  CPU Time, hundredths 进程使用cpu时间总计, 单位1/100秒<br>The same as ’TIME’, but reflecting more granularity through hundredths of a second.</p>
<p>n: %MEM  –  Memory usage (RES) 使用物理内存占用比<br>A task’s currently used share of available physical memory.</p>
<p>o: VIRT  –  Virtual Image (kb)虚拟内存使用量<br>The  total amount of virtual memory used by the task.  It includes all code, data and shared libraries plus pages that have been swapped out. (Note: you can define the STATSIZE=1 environment variable and the VIRT will be calculated from the /proc/#/state VmSize field.)</p>
<p>p: SWAP  –  Swapped size (kb) 使用虚拟内存，被换出的大小<br>Per-process swap values are now taken from /proc/#/status VmSwap field.</p>
<p>q: RES  –  Resident size (kb) 进程使用的，未被还出的物理内存大小<br>The non-swapped physical memory a task has used.<br>RES = CODE + DATA.</p>
<p>r: CODE  –  Code size (kb) 可执行的代码占用物理内存的大小<br>The amount of physical memory devoted to executable code, also known as the ’text resident set’ size or TRS.</p>
<p>s: DATA  –  Data+Stack size (kb) 可执行代码以外的部分（数据段+棧)占用物理内存的大小<br>The amount of physical memory devoted to other than executable code, also known as the ’data resident set’ size or DRS.</p>
<p>t: SHR  –  Shared Mem size (kb) 共享内存大小<br>The amount of shared memory used by a task.  It simply reflects memory that could be potentially shared with other processes.</p>
<p>u: nFLT  –  Page Fault count  页面错误次数<br>The number of major page faults that have occurred for a task.  A page fault occurs when a process attempts to read from or write to a virtual page that</p>
<p>v: nDRT  –  Dirty Pages count 最后一次写入，未被修改的的页面数<br>The number of pages that have been modified since they were last written to disk.  Dirty pages must be written to disk before the corresponding physical memory location can be used for some other virtual page.</p>
<p>w: S  –  Process Status 进程状态<br>The status of the task which can be one of:<br>    ’D’ = uninterruptible sleep()<br>    ’R’ = running<br>    ’S’ = sleeping<br>    ’T’ = traced or stopped<br>    ’Z’ = zombie(僵尸进程数)<br>Tasks shown as running should be more properly thought of as ’ready to run’  –  their task_struct is simply represented on the Linux  run-queue.   Even without a true SMP machine, you may see numerous tasks in this state depending on top’s delay interval and nice value.</p>
<p>x: Command  –  Command line or Program name 命令名<br>Display the command line used to start a task or the name of the associated program.  You toggle between command line and name with ’c’, which is both a command-line option and an interactive command.When you’ve chosen to display command lines, processes without a command line (like kernel threads) will be shown with only the program name  in  paren-theses, as in this example:<br>( mdrecoveryd  )<br>Either  form  of display is subject to potential truncation if it’s too long to fit in this field’s current width.  That width depends upon other fields selected, their order and the current screen width.<br>Note: The ’Command’ field/column is unique, in that it is not fixed-width.  When displayed, this column will be allocated all remaining screen width (up to the maximum 512 characters) to provide for the potential growth of program names into command lines.</p>
<p>y: WCHAN  –  Sleeping in Function 睡眠状态的进程系统函数名<br>Depending  on  the  availability of the kernel link map (’System.map’), this field will show the name or the address of the kernel function in which the task is currently sleeping.  Running tasks will display a dash (’-’) in this column.<br>Note: By displaying this field, top’s own working set will be increased by over 700Kb.  Your only means of reducing that overhead will be  to  stop  and restart top.</p>
<p>z: Flags  –  Task Flags 任务标志<br>This column represents the task’s current scheduling flags which are expressed in hexadecimal notation and with zeros suppressed.  These flags are offi-cially documented in <linux sched.h="">.  Less formal documentation can also be found on the ’Fields select’ and ’Order fields’ screens.</linux></p>
<p>以上均摘录自手册，供大家参考，使用!</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2016/12/10/关于一个接口的设计/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/10/关于一个接口的设计/" itemprop="url">
                  关于一个接口的设计
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-10T22:03:36+08:00">
                2016-12-10
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>对最近的工作做一个总结和反思，最近在处理消息分片的工作，先介绍下应用的场景：<br>我们在做一个直播的产品，直播中会存在很多消息，这样就需要对消息进行处理，然后回放的时候，会用到这些存储的文件，我们目前使用的第三方的聊天室系统，需要对第三方的消息同步到我们的系统存储起来，一方面便于查询问题，因为消息内容中除了第三方的自定义的协议之外，也会涉及到我们业务数据的上报；另外一方面，不需要依赖第三方服务，对自己的数据管控。在改版之前，第三方会在直播结束，会回调我们的接口，进行消息的同步，写入异步队列，实现串行处理，之前每个直播消息，会生成独立的一个文件，放到云存储s3，由于消息文件过大，导致有些回播在下载消息文件的过程中，加载时间太慢，甚至导致客户端app直接崩溃，为此，之前有人改过一版，只是对于消息过于大的文件，进行了不处理，也就是完全的抛弃掉，回播不会存在聊天消息，这种处理太过于武断，没有从根本上解决问题</p>
<p>在处理这个问题的过程中，遇到了一些问题<br>之前的处理方式：<br>    将消息文件从redis落地，将消息文件存放于磁盘，然后用shell脚本实现同步到s3</p>
<p>方案一<br>    我没有修改既有的这种方式，甚至没有对这种方式产生任何的质疑， 于是做了如下的设计</p>
<p>1.新增接口，提供消息分片的文件列表，需要服务端存储某个视频的消息分片的文件的列表<br>2.仍然使用既有使用shell脚本同步消息文件的方案</p>
<p>这样的设计有什么问题呢？<br>1.浪费了存储空间，这些消息文件是静态的文件，生成之后就不会变，所以并不需要把消息分片文件列表存放于redis中<br>2.消息文件的同步，将消息文件存放于本地磁盘，然后使用shell脚本同步，而且同步进程使用的单进程，实践证明，这种方式并不是最好的，由于产生的文件的数量比较多，导致消费脚本处理不过来，产生消息文件的积压</p>
<p>方案二<br>1.做好对旧版本的兼容，对接口进行修改，提供消息文件的索引文件，索引文件是消息分片文件上传到s3之后的文件列表<br>2.不基于shell脚本处理，基于s3提供的sdk，完全使用同步的方式进行处理，即不将redis中的消息内容落地处理，不生成消息文件<br>3.动态生成消息分片文件的时候，同时生成消息索引文件，并同步到s3</p>
<p>索引文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">&#123;</div><div class="line">  timestamp: &quot;1481188775520&quot;,</div><div class="line">  url: &quot;http://test.s3.amazonaws.com/cheetahlive/15/33/14811887487207113059/14811887487207113059_0.json&quot;</div><div class="line">&#125;</div><div class="line">&#123;</div><div class="line">  timestamp: &quot;1481188775520&quot;,</div><div class="line">  url: &quot;http://test.s3.amazonaws.com/cheetahlive/15/33/14811887487207113059/14811887487207113059_1.json&quot;</div><div class="line">&#125;</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">]</div></pre></td></tr></table></figure></p>
<p>这样，既解决了服务端的存储问题，不用再存储消息分片文件了，直接客户端通过接口请求，拿到消息索引文件，通过解析消息索引文件，得到所需要的消息索引文件列表，同时解决了消息文件存放于存盘，产生的消费能力跟不上导致的文件积压的问题，如果文件比较多，还可以对回调任务处理脚本使用多进程的方式，不用考虑到是否会产生多个进程同时消费一个消息文件的问题，完美支持多进程，这样设计似乎完美了吧？</p>
<p>真的完美么？</p>
<p>方案三<br>在方案二的基础上做了以下的修改<br>方案二会产生什么问题呢？<br>1.客户端要下载消息文件，需要先请求索引文件接口，下载并解析索引文件，获取消息分片文件列表，客户端同学会说，你的接口太难用了得改啊<br>2.流量问题，移动端应用，最需要考虑的问题之一，就是能省流量<br>如何更友好的处理这些问题呢？<br>1.简化接口，还是使用索引列表的方式返回，但是处理方式跟方案一不同的地方是，服务端请求索引文件，解析并通过接口返回<br>2.生成的消息文件使用gz压缩，当然这个压缩需要s3支持，开启s3的gz压缩模式，减少消息的传输</p>
<p>到此，也算是比较完美的了，不知道还没有比较好的方案来处理这个问题？希望能得到大家的交流！</p>
<p>总结：<br>1.在接口升级的过程中需要考虑到客户端新老版本的兼容性<br>2.对于同步处理还是异步处理的选择，根据特定的业务场景进行选择，考虑有没有必要使用异步处理，不是所有场景都适合使用异步处理的方式<br>3.文件存储，考虑磁盘的使用文件，目录划分<br>4.消费模型，必须需要考虑生产者和消息者之间能力匹配问题，不然会产生积压<br>5.对于数据的处理方式和存储方式，不是所有的数据都需要使用内存或者数据库存储，可以使用云存储，结合cdn技术，更好的管理静态文件<br>6.对于考虑一个方案的时候，需要做更多的可能性测试，通过测试来选取最佳方案<br>7.在思考方案的时候，需要从头到尾的考虑整个的数据的处理过程，可能是一个回路，只是变更一种数据获取方式，所以考虑的时候，尽可能的考虑每一个数据上处理的环节</p>
<p>人因为梦想而伟大，产品因为一个更好的技术方案而解放我们，多思考细节的东西，才能挖掘别人看不到的东西，一切变化，都因为在变！！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://chanlan.github.io/2016/12/06/一个shell脚本/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Kivmi">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Learn And Life.">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Learn And Life." src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/06/一个shell脚本/" itemprop="url">
                  一个shell脚本
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-06T18:50:32+08:00">
                2016-12-06
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>工作中有时候需要使用shell来做一些文件处理，但是在使用shell脚本之前，先确定是否使用该方案来处理，以下是我一个位上线的脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">###############################</div><div class="line"># 消息进程管理                                    #</div><div class="line">#                                                        #</div><div class="line"># Author:  chenjx                               #</div><div class="line"># Since:   2016-12-05                       #</div><div class="line"># version: 1.0                                    #</div><div class="line">###############################</div><div class="line">OLD_DIR=&apos;/data/logs/message/msg/&apos;</div><div class="line">NEW_DIR=&apos;/data/logs/message/newMsg/&apos;</div><div class="line">SHELL_CMD=&apos;/bin/bash&apos;</div><div class="line">CURRENT_DIR=`pwd`</div><div class="line">SHELL_SCRIPT=&quot;$&#123;CURRENT_DIR&#125;/pushmsgtos3one.sh&quot;</div><div class="line">LOG_FILE=&apos;/data/logs/message/process_log.txt&apos;</div><div class="line">PROCESS_NUM_LIST=`ps aux|grep &apos;pushmsgtos3one.sh&apos;|awk -F &apos; &apos; &apos;&#123;if($13)&#123;print $13&#125;&#125;&apos;`</div><div class="line">DIRECTORY_SEPARATOR=&apos;/&apos;</div><div class="line"></div><div class="line">#检查进程</div><div class="line">checkNewProcess()&#123;</div><div class="line">    RET=1</div><div class="line"></div><div class="line">    if [ -d $1 -a  -x $&#123;SHELL_SCRIPT&#125; ]</div><div class="line">    then </div><div class="line">        for CHILD_DIR in `ls $1`</div><div class="line">        do </div><div class="line">            if echo &quot;$&#123;PROCESS_NUM_LIST[@]&#125;&quot; | grep -w $&#123;CHILD_DIR&#125;</div><div class="line">            then </div><div class="line">                RET=0</div><div class="line">            else </div><div class="line">                $&#123;SHELL_CMD&#125; $&#123;SHELL_SCRIPT&#125; $1$&#123;CHILD_DIR&#125;$&#123;DIRECTORY_SEPARATOR&#125;  &amp;</div><div class="line">                if [ $? -ne &apos;0&apos; ]</div><div class="line">                then </div><div class="line">                    echo  &apos;&gt; NEW:&apos; $&#123;SHELL_SCRIPT&#125; $&#123;CHILD_DIR&#125; &apos; Error&apos; &gt;&gt; $&#123;LOG_FILE&#125; </div><div class="line">                fi</div><div class="line">            fi</div><div class="line">        done  </div><div class="line">    else </div><div class="line">        echo $&#123;OLD_DIR&#125; $&#123;NEW_DIR&#125;&apos; Check  Error&apos; &gt;&gt; $&#123;LOG_FILE&#125;</div><div class="line">    fi</div><div class="line"></div><div class="line">    return $RET</div><div class="line">&#125;</div><div class="line"></div><div class="line">#兼容老版本</div><div class="line">checkOldProcess()&#123;</div><div class="line">    RET=1</div><div class="line"></div><div class="line">    if [ -d $1 -a  -x $&#123;SHELL_SCRIPT&#125; ]</div><div class="line">    then </div><div class="line">        $&#123;SHELL_CMD&#125; $&#123;SHELL_SCRIPT&#125; $1  &amp;</div><div class="line">        if [ $? -ne &apos;0&apos; ]</div><div class="line">        then </div><div class="line">            echo  &apos;&gt; OLD:&apos; $&#123;SHELL_SCRIPT&#125; $&#123;CHILD_DIR&#125; &apos; Error&apos; &gt;&gt; $&#123;LOG_FILE&#125; </div><div class="line">        fi</div><div class="line">    fi</div><div class="line"></div><div class="line">    return $RET</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">checkOldProcess $&#123;OLD_DIR&#125;</div><div class="line">checkNewProcess $&#123;NEW_DIR&#125;</div></pre></td></tr></table></figure></p>
<p>只是方案进行了修改，不使用这种方式来处理，由于需要清理分支，所以记录下来！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>


    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Kivmi" />
          <p class="site-author-name" itemprop="name">Kivmi</p>
          <p class="site-description motion-element" itemprop="description">代码也是有灵魂的</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">15</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kivmi</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	




  
  

  

  

  

  


</body>
</html>
